【Project-Tsurugi Internal Use Only】

# metadata-manager 列統計・表統計 管理機能 機能設計

2021.02.03 NEC

* metadata-manager
  * 今回開発するバージョンは、V3.0とします。
  
## 目次

<!-- TOC -->

- [metadata-manager 列統計・表統計 管理機能 機能設計](#metadata-manager-列統計表統計-管理機能-機能設計)
    - [目次](#目次)
    - [用語](#用語)
    - [列統計・表統計 管理機能 概要](#列統計表統計-管理機能-概要)
        - [2021年3月までの開発スコープ](#2021年3月までの開発スコープ)
    - [メタデータ格納先のデータベース設計](#メタデータ格納先のデータベース設計)
        - [概要](#概要)
        - [メタデータ格納先](#メタデータ格納先)
        - [メタデータ格納先テーブルのデータベース・スキーマ](#メタデータ格納先テーブルのデータベーススキーマ)
            - [理由](#理由)
        - [メタデータ格納先テーブルの権限](#メタデータ格納先テーブルの権限)
        - [V3.0で追加するテーブル](#v30で追加するテーブル)
            - [V3.0で追加するテーブル一覧](#v30で追加するテーブル一覧)
            - [列統計テーブル](#列統計テーブル)
                - [制約](#制約)
                - [jsonスキーマ](#jsonスキーマ)
                - [PostgreSQLシステムカタログのpg_statisticテーブルの列との相違点](#postgresqlシステムカタログのpg_statisticテーブルの列との相違点)
            - [Tableメタデータテーブル](#tableメタデータテーブル)
                - [制約](#制約-1)
                - [PostgreSQLシステムカタログのpg_classテーブルとの相違点](#postgresqlシステムカタログのpg_classテーブルとの相違点)
            - [Columnメタデータテーブル](#columnメタデータテーブル)
                - [制約](#制約-2)
                - [PostgreSQLシステムカタログのpg_attributeテーブルとの相違点](#postgresqlシステムカタログのpg_attributeテーブルとの相違点)
    - [Tsurugi利用者が実施する環境設定](#tsurugi利用者が実施する環境設定)
        - [メタデータ格納先のテーブル定義設定](#メタデータ格納先のテーブル定義設定)
        - [メタデータ格納先への接続先設定](#メタデータ格納先への接続先設定)
            - [環境変数一覧](#環境変数一覧)
            - [フォーマット](#フォーマット)
    - [メタデータ管理機能 共通API](#メタデータ管理機能-共通api)
        - [初期化処理](#初期化処理)
            - [処理概要](#処理概要)
            - [引数](#引数)
            - [戻り値](#戻り値)
            - [条件](#条件)
    - [列統計・表統計管理機能 API](#列統計表統計管理機能-api)
        - [列統計・表統計 管理機能APIのinputについて](#列統計表統計-管理機能apiのinputについて)
        - [1カラムの列統計登録・更新（input：テーブルID・カラム番号）](#1カラムの列統計登録更新inputテーブルidカラム番号)
            - [処理概要](#処理概要-1)
            - [引数](#引数-1)
            - [戻り値](#戻り値-1)
            - [条件](#条件-1)
            - [処理詳細](#処理詳細)
        - [1テーブルの表統計登録・更新（input：テーブルID・行数）](#1テーブルの表統計登録更新inputテーブルid行数)
            - [処理概要](#処理概要-2)
            - [引数](#引数-2)
            - [戻り値](#戻り値-2)
            - [条件](#条件-2)
            - [処理詳細](#処理詳細-1)
        - [1テーブルの表統計登録・更新（input：テーブル名・行数、output：テーブルID）](#1テーブルの表統計登録更新inputテーブル名行数outputテーブルid)
            - [処理概要](#処理概要-3)
            - [引数](#引数-3)
            - [戻り値](#戻り値-3)
            - [条件](#条件-3)
            - [処理詳細](#処理詳細-2)
        - [1テーブルの全列統計参照（input：テーブルID）](#1テーブルの全列統計参照inputテーブルid)
            - [処理概要](#処理概要-4)
            - [引数](#引数-4)
            - [戻り値](#戻り値-4)
            - [条件](#条件-4)
            - [処理詳細](#処理詳細-3)
        - [1カラムの列統計参照（input：テーブルID・カラム番号）](#1カラムの列統計参照inputテーブルidカラム番号)
            - [処理概要](#処理概要-5)
            - [引数](#引数-5)
            - [戻り値](#戻り値-5)
            - [条件](#条件-5)
            - [処理詳細](#処理詳細-4)
        - [1テーブルの表統計参照（input：テーブルID）](#1テーブルの表統計参照inputテーブルid)
            - [処理概要](#処理概要-6)
            - [引数](#引数-6)
            - [戻り値](#戻り値-6)
            - [条件](#条件-6)
            - [処理詳細](#処理詳細-5)
        - [1テーブルの表統計参照（input：テーブル名、output：テーブルID・行数）](#1テーブルの表統計参照inputテーブル名outputテーブルid行数)
            - [処理概要](#処理概要-7)
            - [引数](#引数-7)
            - [戻り値](#戻り値-7)
            - [条件](#条件-7)
            - [処理詳細](#処理詳細-6)
        - [1テーブルの全列統計削除（input：テーブルID）](#1テーブルの全列統計削除inputテーブルid)
            - [処理概要](#処理概要-8)
            - [引数](#引数-8)
            - [戻り値](#戻り値-8)
            - [条件](#条件-8)
            - [処理詳細](#処理詳細-7)
        - [1カラムの列統計削除（input：テーブルID・カラム番号）](#1カラムの列統計削除inputテーブルidカラム番号)
            - [処理概要](#処理概要-9)
            - [引数](#引数-9)
            - [戻り値](#戻り値-9)
            - [条件](#条件-9)
            - [処理詳細](#処理詳細-8)
    - [エラーコード一覧](#エラーコード一覧)
    - [ログ](#ログ)


## 用語

* 利用者
  * Tsurugiを利用する人
* メタデータ格納先
  * メタデータが永続的に保存される場所

## 列統計・表統計 管理機能 概要

### 2021年3月までの開発スコープ
* メタデータ管理機能共通API
  * 初期化処理

* 列統計・表統計管理機能API
  * 列統計登録・更新
    * 1カラムの列統計登録・更新（input：テーブルID・カラム番号）
  * 表統計登録・更新
    * 1テーブルの表統計登録・更新（input：テーブルID・行数）
    * 1テーブルの表統計登録・更新（input：テーブル名・行数、output：テーブルID）★開発スコープ外：時間があれば開発する。
  * 列統計参照
    * 1カラムの列統計参照（input：テーブルID・カラム番号）
    * 1テーブルの全列統計参照（input：テーブルID）★開発スコープ外：時間があれば開発する。
  * 表統計参照
    * 1テーブルの表統計参照（input：テーブルID）
    * 1テーブルの表統計参照（input：テーブル名、output：テーブルID・行数）★開発スコープ外：時間があれば開発する。
  * 列統計削除
    * 1カラムの列統計削除（input：テーブルID・カラム番号）
    * 1テーブルの全列統計削除（input：テーブルID）★開発スコープ外：時間があれば開発する。
    



* ★以外のAPIを作成すれば、最低限、列統計・表統計が管理可能となる。



## メタデータ格納先のデータベース設計

### 概要

* V2.0では、次のメタデータをjsonファイルにjson形式で格納していた。V3.0では、性能を考慮して、リレーショナルデータベースにテーブル形式で格納する。
  * Tableメタデータオブジェクト
  * Columnメタデータオブジェクト
  * DataTypesメタデータオブジェクト
    * メタデータフォーマットは次を参照
    * https://github.com/project-tsurugi/manager/blob/master/metadata-manager/docs/table_metadata.md#%E3%83%A1%E3%82%BF%E3%83%87%E3%83%BC%E3%82%BF%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%88
* Tableメタデータ・Columnメタデータ
  * V3.0では、V2.0の概念スキーマをそのまま流用し、Tableメタデータ・Columnメタデータ・表統計を、データベースに格納する。
    * 理由
      * 列統計・表統計管理機能APIで、Columnメタデータテーブルのカラム番号との参照制約を設定するため。
      * Tableメタデータテーブルに表統計を追加するため。
* 列統計
  * V3.0で概念スキーマを新規に設計し、列統計をデータベースに格納する。

    

### メタデータ格納先

* メタデータ格納先
  * PostgreSQL
* metadata-managerがメタデータ格納先に問い合わせするAPI
  * [libpq](https://www.postgresql.jp/document/12/html/libpq.html)



### メタデータ格納先テーブルのデータベース・スキーマ

* メタデータが格納されるテーブルのデータベースは、デフォルトでは次の表の通りとする。
  * OSの環境変数で、データベース名・ホスト名・ポート・ユーザー名・パスワードを変更可能とする。
    * 詳細は[Tsurugi利用者が実施する環境設定](#Tsurugi利用者が実施する環境設定)を参照

| 項目                                     | デフォルト値                                                 |
| ---------------------------------------- | ------------------------------------------------------------ |
| データベース名                           | tsurugi                                                      |
| ホスト名                                 | localhost                                                    |
| ポート                                   | 5432                                                         |
| ユーザー名                               | カレントユーザー[^2]                                         |
| パスワード                               | <カレントユーザー[^2]のホームディレクトリの絶対パス>/.pgpass |
| LC_COLLATE                               | 'C'                                                          |
| LC_CTYPE                                 | 'C'                                                          |
| ENCODING                                 | 'UTF8'                                                       |
| 設定をコピーするtemplateデータベース[^1] | template0                                                    |

[^1]:https://www.postgresql.jp/document/12/html/manage-ag-templatedbs.html
[^2]: Tsurugiのインストールを実施するユーザー


* メタデータが格納されるテーブルのスキーマは次の通りとする。
  * スキーマ名
    
    * tsurugi_catalog
    
      

#### 理由

* データベース名をtsurugiにした理由
  * データベースtemplate0
    * PostgreSQLの仕様として、template0にオブジェクトを作成できない仕様となっている。
  * データベースtemplate1
    * template1にオブジェクトを作成してから、template1をコピーして他のデータベースを作成する用途がある。そのため、オブジェクトを作成すると、ユーザーの迷惑となる。

* スキーマ名がpg_catalogでない理由
  
  * PostgreSQLでは、pg_catalog.*のテーブルを定義することは禁止されているため。
    * pg_catalog.tsurugi_classのテーブルを定義したときのエラーメッセージ
    
      ```bash
      ERROR:  permission denied to create "pg_catalog.tsurugi_class"
      DETAIL:  System catalog modifications are currently disallowed.
      ```
    * postgresql-12.3/src/backend/catalog/heap.c
    
      ```c
      /*
       * Don't allow creating relations in pg_catalog directly, even though it
       * is allowed to move user defined relations there. Semantics with search
       * paths including pg_catalog are too confusing for now.
       *
       * But allow creating indexes on relations in pg_catalog even if
       * allow_system_table_mods = off, upper layers already guarantee it's on a
       * user defined relation, not a system one.
       */
      ```

### メタデータ格納先テーブルの権限
* V3.0で追加する全テーブルに対して、Superuserのみにテーブル操作に関するすべての権限を付与する。
  * テーブル操作すべての権限
    * INSERT可能(append)
    * SELECT可能(read)
    * UPDATE可能(write)
    * DELETE可能(delete)
    * TRUNCATE
    * REFERENCES
    * TRIGGER
    
  * Superuser以外のユーザーは、テーブル操作すべての権限を持たない。
  
  * SQL
    
    * Superuserのみにテーブル操作すべての権限を付与するとき、Superuserで次のコマンドを実行する。
      
      ```sql
      GRANT ALL ON ALL TABLES IN SCHEMA tsurugi_catalog To current_user;
      ```
      
      
    
  
* 理由
  * PostgreSQLと同等の仕様とするため。
    * postgresがSuperuserの場合
    
      ```sql
      postgres=# \du postgres
                                     List of roles
       Role name |                         Attributes                         | Member of
      -----------+------------------------------------------------------------+-----------
       postgres   | Superuser, Create role, Create DB, Replication, Bypass RLS | {}
      
      postgres=# SELECT relname, relacl FROM pg_class c JOIN pg_namespace ns ON (ns.oid = c.relnamespace) WHERE relname = 'pg_attribute' or relname = 'pg_class' or relname = 'pg_statistic';
         relname    |                relacl
      --------------+--------------------------------------
       pg_statistic | {postgres=arwdDxt/postgres}
       pg_attribute | {postgres=arwdDxt/postgres,=r/postgres}
       pg_class     | {postgres=arwdDxt/postgres,=r/postgres}
      (3 rows)
      ```



### V3.0で追加するテーブル

#### V3.0で追加するテーブル一覧

* 列統計テーブル
  * テーブル名：tsurugi_statistic
* Tableメタデータテーブル
  * テーブル名：tsurugi_class
* Columnメタデータテーブル
  * テーブル名：tsurugi_attribute



#### 列統計テーブル

* テーブル名
  * **tsurugi_statistic**

| 名前          | 型                                                        | 説明                                                         | NOT NULL |
| ------------- | --------------------------------------------------------- | ------------------------------------------------------------ | -------- |
| **tableId**   | **bigint**                                                | **テーブルID**                                               | NOT NULL |
| **ordinalPosition**  | **bigint**                                                | **カラム番号(1 origin)**                                                 | NOT NULL |
| **columnStatistic** | **json<br/>※ただし、jsonスキーマは、列統計管理機能APIを利用するコンポーネントが決定する。<br/>metadata-managerはjsonスキーマのバリデーションは行わない。** | **列統計** |          |

* カラムIDでなくカラム番号(1 origin)にした理由
  * カラムIDやカラム名を知らなくても、カラム番号で列統計をCRUDできる。
  * カラム番号(1 origin)の1番からソートして順番に表示することができる。
    * カラムIDだと、カラムの位置が分かりにくい。
  * 他のDBMSもカラム番号(1 origin)を使っている。
    * PostgreSQLの列統計
      * カラム番号(1 origin)を使っている。
      * https://www.postgresql.jp/document/12/html/catalog-pg-statistic.html

    * oracleの列統計
      * カラム番号(1 origin)を使っている。
      * https://docs.oracle.com/cd/E16338_01/server.112/b56311/statviews_2103.htm

##### 制約

* indexを張ることで検索速度を速くする、また、行データに一意性を持たせ、行データを特定するため、次の制約を追加する。
  * primary key制約
    * (tableId, ordinalPosition)の複合主キー
      * 理由
        * PostgreSQLでは、(テーブルID, カラム番号, 継承関係の子の列を含むか否か)の複合UNIQUE制約
        * しかし、本テーブルの場合、継承関係の子の列を含むか否かは、V3.0では継承テーブルがサポートされないため、複合主キーに含めない。
* 次の参照制約を追加する。
  * (tableId, ordinalPosition)の複合参照制約
    * 被参照テーブル
      * Columnメタデータテーブル tsurugi_attribute
    * 被参照列
      * TableメタデータのテーブルID id
      * Columnメタデータテーブルのカラム番号 ordinalPosition
    * MATCH FULL

##### jsonスキーマ
* jsonスキーマは、列統計管理機能APIを利用するコンポーネントが決定する。
* 推奨するkey/value
  * データ型
    * データ型のkeyを格納することを推奨する。
    * 例
    
      ```json
      {
        "data-type":"string"
      }
      ```
      
    * データ型のkeyの格納を推奨する理由
      * 列統計の値の型は、metadata-managerのデータ型管理機能API・Columnメタデータ管理機能APIを利用して取得する必要がある。
      * データ型のkeyを挿入しないより挿入したほうが、列統計・表統計管理機能APIのみを利用するだけでよいため、実行速度が速くなる。

##### PostgreSQLシステムカタログのpg_statisticテーブルの列との相違点

* pg_statisticテーブルの列統計の複数カラムを、1つのjson型カラムに集約

  * 理由
    * metadata-managerのAPIを利用するコンポーネントが、Tsurugi独自の列統計を格納できるようにするため。
    * metadata-managerのAPIを利用するコンポーネントが、データ構造を自由に決められるため。
      * Tsurugi独自のjsonスキーマでもよい。
      * PostgreSQLと同様に、スロット形式のjsonスキーマで格納してもよい。
      * MySQLと同様のjson形式で格納してもよい。
        * 26.11 The INFORMATION_SCHEMA COLUMN_STATISTICS Table
          * https://dev.mysql.com/doc/refman/8.0/en/information-schema-column-statistics-table.html
        * jsonスキーマの例
          * https://dev.mysql.com/doc/refman/8.0/en/optimizer-statistics.html
* 参照制約を追加
  * 列統計テーブルの（テーブルID、カラム番号）に、Columnメタデータテーブルの（テーブルID、カラム番号）への参照制約を追加
    * （テーブルID、カラム番号）との参照関係を示して、カラムIDと間違えないようにするため。
* 型
  * PostgreSQLの型oid、staattnumの型int2それぞれを、bigintに変更
    * 理由
      * metadata-manager V2.0で、テーブルID・カラム番号の型が、uint64_tで定義されているため。

#### Tableメタデータテーブル

* テーブル名
  * **tsurugi_class**
    * V2.0と概念スキーマは同じ。

| 名前          | 型                                                        | 説明                                                         | REFERENCES                              | NOT NULL |
| ------------- | --------------------------------------------------------- | ------------------------------------------------------------ | --------------------------------------- | -------- |
| **id**   | **bigserial**                                       | **テーブルID**                                               |  | NOT NULL |
| **name** | **text** | **テーブル名** | | NOT NULL |
| **namespace** | **text** | **名前空間（テーブル名を除く）** | | |
| **primaryKey** | **json<br>※値はarray[bigint]が挿入されるが、<br/>metadata-managerはjsonスキーマのバリデーションは行わない。** | **primaryKeyカラムのカラム番号"ordinalPosition"** |  |  |
| reltuples | real | 行数 | | |

##### 制約

* indexを張ることで検索速度を速くする、また、行データに一意性を持たせ、行データを特定するため、次の制約を追加する。
  * primary key制約
    * id
  * PostgreSQLではnameとnamespaceがUNIQUE制約であるが、tsurugiでは両方UNIQUE制約は設定しない。
    * 理由
      * 前提として、同名のテーブル名は、テーブルメタデータテーブルおよびOLTPに登録できない仕様となっているが、frontendでogawayama-serverから返却されたエラーコードを表示するため。
      * V3.0でnamespaceはサポートされないため、namespaceはUNIQUE制約に含めない。



##### PostgreSQLシステムカタログのpg_classテーブルとの相違点

* 太字がpg_classとの変更点
* 列の変更
  * 表統計
    
    * reltuplesのNOT NULL制約を削除。
      * 理由
        * metadata-managerのAPIを利用するTsurugiのコンポーネント（ogawayamaなど）が格納する表統計が決まっていないため。
    * pg_classテーブルのreltuples以外の表統計が存在しない。
      * 理由
        * 実行エンジンにページ数の概念がない可能性があるため。
        * プランナが計算する選択度の計算に、行数以外の表統計は不要であるため。
    
  * primaryKey列を追加
    * 理由
      * metadata-manager V2.0と同様に、metadata-managerがptree型のオブジェクトで受け取ったprimaryKeyを、メタデータ格納先にjson型でそのまま格納するため。
  * primaryKey列にNOT NULL制約が設定されていない。
    * 理由
      * PostgreSQLでは、主キー制約がないテーブルを定義できるため。
        * ただし、Tsurugiでは、主キーを必ず1つ以上設定する必要がある。

#### Columnメタデータテーブル

* テーブル名
  * **tsurugi_attribute**
    * V2.0と概念スキーマは同じ。

| 名前                | 型                                                           | 説明             | REFERENCES                              | NOT NULL |
| ------------------- | ------------------------------------------------------------ | ---------------- | --------------------------------------- | -------- |
| **id**        | **bigserial**                                                | **カラムID**     |                                         | NOT NULL |
| **tableId**         | **bigint**                                                   | **テーブルID**   | **TableメタデータテーブルのテーブルID** | NOT NULL |
| **name**            | **text**                                                  | **カラム名**     |                                         | NOT NULL |
| **ordinalPosition**            | **bigint**                                                  | **カラム番号(1 origin)**     |                                         | NOT NULL |
| **dataTypeId**            | **bigint**                                                  | **カラムのデータ型のID<br>データタイプメタデータを参照**     |                                         | NOT NULL |
| **dataLength**            | **json<br>※値は、array[bigint]が挿入されるが、<br/>metadata-managerはjsonスキーマのバリデーションは行わない。**                                                | **データ長(配列長)<br>varchar(20)など ※V1では未使用<br>NUMERIC(precision,scale)を考慮してarray[bigint] にしている。<br>array[bigint] か number かは継続して検討。**     |                                         |  |
| **varying**            | **bool**                                                  | **文字列長が可変か否か**     |                                         |  |
| **nullable**            | **bool**                                                  | **NOT NULL制約の有無**     |                                         | NOT NULL |
| **defaultExpr**        | **text**                                                  | **デフォルト式**     |                                         | |
| **direction**            | **bigint**                                                  | **方向（0: DEFAULT, 1: ASCENDANT, 2: DESCENDANT）**     |                                         |  |

##### 制約

* indexを張ることで検索速度を速くする、また、行データに一意性を持たせ、行データを特定するため、次の制約を追加する。
  * primary key制約
    * (tableId, id)の複合主キー
  * UNIQUE制約
    * (tableId, name)の複合UNIQUE制約
      * PostgreSQLと同じ
    * (tableId, ordinalPosition)の複合UNIQUE制約
      * PostgreSQLと同じ

##### PostgreSQLシステムカタログのpg_attributeテーブルとの相違点

* 太字がpg_attributeとの変更点
* すべての列を変更した
  * 理由
    
    * indexを張ることで検索速度を速くするため。
    
    * V2.0のメタデータの概念スキーマと同じ概念スキーマとするため。
    
      * metadata-manager V2.0と同様に、metadata-managerがptree型のオブジェクトで受け取ったColumnメタデータを、メタデータ格納先に永続化するため。
    
      

## Tsurugi利用者が実施する環境設定

### メタデータ格納先のテーブル定義設定

* Tsurugiの利用者は、Tsurugiのインストール時に、SQLファイルを実行する。

  * SQLファイルの内容
    1. 次のコマンドを実行して、データベースを作成する。
    
      ```sql
      CREATE DATABASE tsurugi LC_COLLATE 'C' LC_CTYPE 'C' ENCODING 'UTF8' template=template0;
      ```
    
    2. CREATE SCHEMA tsurugi_catalog;
    3. [メタデータ格納先のデータベース設計](#メタデータ格納先のデータベース設計)の全テーブルのテーブル定義を行う。
       * 制約の定義も行う。
    4. スキーマtsurugi_catalogの全テーブルに対して、Superuserのみにテーブル操作に関するすべての権限を付与する。

### メタデータ格納先への接続先設定

* metadata-managerは、メタデータ格納先に関するデフォルトの接続先情報（Connection Strings）を利用して、メタデータ格納先に接続する。
  * Tsurugiの利用者は、メタデータ格納先の接続先を変更したい場合、OSの環境変数でConnection Stringsを設定する。

#### 環境変数一覧

| No.  | 項目名     | 環境変数名       | デフォルト値 | 値の範囲                                       |
| ---- | ---------- | ---------------- | ------------ | ---------------------------------------------- |
| 1    | Connection Strings | TSURUGI_CONNECTION_STRING | "dbname = tsurugi"     | メタデータ格納先の接続先情報 |

#### フォーマット

* Connection Strings

  * libpqで利用できるConnection Stringsのフォーマット[^3]のうち、「Keyword/Value Connection Strings」「Connection URIs」のどちらかのフォーマットとする。

    * [^3]:「libpq - 33.1.1. Connection Strings」https://www.postgresql.org/docs/12/libpq-connect.html#LIBPQ-CONNSTRING ↩

    * ただし、次の制限事項がある。

      * データベース名・ホスト名・ポート・ユーザー名・パスワードのみ指定可能。それ以外のパラメーターは指定不可。
      * データベース名・ホスト名・ポート・ユーザー名・パスワードそれぞれ1つずつのみ指定可能。
        * 1つの接続先のみ指定可能。複数の接続先は指定不可。
      
    * 制限事項の理由
      
      * 制限事項に記載のConnection Strings以外をサポートするユースケースがないため。

* 例1

  ```bash
  export TSURUGI_CONNECTION_STRING = "host=localhost port=5432 dbname=mydb" 
  ```

* 例2

  ```bash
  export TSURUGI_CONNECTION_STRING = "postgresql://localhost:5433/mydb" 
  ```



## メタデータ管理機能 共通API

### 初期化処理

#### 処理概要

* メタデータ管理機能API（初期化処理以外）の関数を呼ぶ前に、本APIを呼ぶ。
* 初期化処理を呼ばなければ、他のメタデータ管理機能API内で、初期化処理が呼ばれる。
* 初期化処理は下記3つの処理を実施する。下記3つすべての処理が成功した場合、metadata-managerは、メタデータ格納先とメタデータの受け渡しが可能となる。
  1. metadata-managerは、メタデータ格納先とのコネクションが確立済みでない場合、メタデータ格納先とのコネクションを確立する。
      * コネクションの確立に成功した場合、確立したコネクション1つを保持する。
  2. metadata-managerは、サーチパスがセキュアになるように設定する。
      * 悪意のあるユーザーに制御を奪われないようにするため。
  3. metadata-managerは、メタデータ格納先に対してプリペアードステートメントを送り、プリペアードステートメントの前処理の実行を指示する。

#### 引数

* なし

#### 戻り値

| プロパティ名（論理名） | 型        | 値の範囲                                                     |
| ---------------------- | --------- | ------------------------------------------------------------ |
| エラーコード           | ErrorCode | ErrorCode::OK：正常<br />ErrorCode::DATABASE_ACCESS_FAILURE：メタデータ格納先に障害が発生した。|

#### 条件

* 事前条件

  * なし
* 事後条件

  * 戻り値として、ErrorCodeを返す。
    * ErrorCode::OKが返ってきた場合
      * 列統計・表統計管理機能 APIを利用可能となり、メタデータ格納先とのメタデータの受け渡しが可能となる。
    * ErrorCode::DATABASE_ACCESS_FAILUREが返ってきた場合
      * metadata-managerは、メタデータ格納先とメタデータの受け渡しができない。


## 列統計・表統計管理機能 API
### 列統計・表統計 管理機能APIのinputについて


* 列統計・表統計管理機能APIのinputをテーブルIDとした理由
  1. ogawayamaは、テーブルIDをキャッシュに持っているため。
    * テーブル名からテーブルIDを取得するために、メタデータ格納先にアクセスする必要がない。
  2. inputをテーブルIDで統一するため。

* 列統計管理機能APIのinputを「カラム番号」とした理由

  * カラムIDやカラム名ではなく、カラム番号をinputとすることで、Columnメタデータテーブルにアクセスする必要がなくなるため。
     * 列統計管理機能API利用の流れ
       1. metadata-managerのAPIを利用するTsurugiのコンポーネントは、次の処理を行うときに、各テーブルの「カラム数またはカラム番号のリスト」をメモリに保持する。
          * Tsurugiの利用者がDDL(CREATE TABLE,ALTER TABLE)を発行したとき
          * 自コンポーネントが起動するとき
            * 自コンポーネントが起動するときは、Columnメタデータテーブルから「カラム数またはカラム番号のリスト」を取得する。
       2. metadata-managerのAPIを利用するTsurugiのコンポーネント（ogawayamaなど）は、列統計管理機能APIを利用する。

* 表統計管理機能APIで、inputがテーブル名のAPIを用意した理由
  * 列統計・表統計の登録・更新フロー
       1. 表統計（行数）の登録・更新を行い、テーブルIDを取得する。
          * アクセス先：Tableメタデータテーブル【tsurugi_class】
       2. テーブルIDをinputとし、全カラムの列統計を登録・更新する。
          * アクセス先：列統計テーブル【tsurugi_statistic】
   * 列統計・表統計の参照フロー
       1. 表統計（行数）の参照を行い、テーブルID・行数を取得
          * アクセス先：Tableメタデータテーブル【tsurugi_class】
       2. テーブルIDをinputとし、各カラムの列統計を参照する。
          * アクセス先：列統計テーブル【tsurugi_statistic】

### 1カラムの列統計登録・更新（input：テーブルID・カラム番号）

#### 処理概要

* metadata-managerは、メタデータ格納先に**1カラム単位の列統計**を登録・更新する。
  * 1カラム単位の列統計の全項目を更新する。一部の列統計の部分更新は不可とする。
    * たとえば、NULL率のみの更新はできず、NULL率以外の列統計も一緒に更新しなければならない。
* 登録・更新の単位を、1カラム単位の列統計としている理由
  * PostgreSQLの次のソースコードを参考にしている。
    * postgresql-12.3/src/backend/commands/analyze.c
      * PostgreSQLの列統計登録・更新APIは、引数としてテーブルID・カラム数・全カラムの列統計の値が指定される。
      
        ```C
        /*
         *	update_attstats() -- update attribute statistics for one relation
        (略)
        */
        static void
        update_attstats(Oid relid, bool inh, int natts, VacAttrStats **vacattrstats)
        ```

#### 引数

| プロパティ名<br />（論理名） | プロパティ名<br />（物理名） | 型               | 型の備考     | IN/OUT | 省略指定 | 値の範囲 |
| ---------------------------- | ---------------------------- | ---------------- | ------------ | ------ | -------- | -------- |
| テーブルID                   | table_id                   | int64_t |              | IN     | 省略不可 | 1以上  |
| カラム番号                     | ordinal_position                  | int64_t |              | IN     | 省略不可 | 1以上  |
| 1カラム単位の列統計           | column_statistic                    |  boost::property_tree::ptree&       | **参照渡し** | IN     | 省略不可 | 型の範囲 |

#### 戻り値

| プロパティ名（論理名） | 型        | 値の範囲                                                     |
| ---------------------- | --------- | ------------------------------------------------------------ |
| エラーコード           | ErrorCode | ErrorCode::OK：正常<br />ErrorCode::INVALID_PARAMETER：引数に、テーブルメタデータテーブルに存在しないテーブルID・カラム番号が入力された。<br/>ErrorCode::DATABASE_ACCESS_FAILURE：メタデータ格納先に障害が発生した。 |

#### 条件

* 事前条件

  * 引数に、テーブルID、カラム番号、テーブルID・カラム番号に紐づく1カラム単位の列統計が指定されている。
* 事後条件

  * 戻り値として、ErrorCodeを返す。


#### 処理詳細

1. metadata-managerは、事前条件に基づき、引数の入力規則チェックを実施する。
  * テーブルID < 0 または カラム番号 < 0 の場合
    * metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。
2. メタデータ格納先は、Transactionを開始する。
3. metadata-managerは、メタデータ格納先の列統計テーブル【tsurugi_statistic】から、テーブルID、カラム番号が、引数テーブルID、カラム番号それぞれに一致するレコードを取得する。
   * 一致するレコードが存在する場合
     * メタデータ格納先は、引数column_statisticを基に、テーブルID・カラム番号に一致するレコードの各列に対して、値を上書きする。
   * 一致するレコードが存在しない場合
     * メタデータ格納先は、引数column_statisticを基に、列統計テーブル【tsurugi_statistic】に対して、新たなレコードを登録する。
4. 3.でレコードの登録・更新に成功した場合
   1. メタデータ格納先は、commit処理を行い、Transactionを終了する。
   2. metadata-managerは、戻り値にErrorCode::OKを設定し、処理を終了する。
5. 3.でレコードの登録・更新に失敗した場合
   1. メタデータ格納先は、rollback処理を行い、Transactionを終了する。
   2. metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。

### 1テーブルの表統計登録・更新（input：テーブルID・行数）

#### 処理概要

* metadata-managerは、メタデータ格納先に対して、**1テーブル単位の表統計**を登録・更新する。

* 登録・更新の単位を、1テーブル単位の表統計としている理由
  * PostgreSQLの次のソースコードを参考にした。
    * postgresql-12.3/src/backend/commands/vacuum.c
      * PostgreSQLの場合、表統計登録・更新APIは、引数としてテーブルIDを含むRelation構造体・行数num_tuplesが指定される。
      
        ```C
        /*
         *	vac_update_relstats() -- update statistics for one relation
        （略）
         */
        void
        vac_update_relstats(Relation relation,
                            BlockNumber num_pages, double num_tuples,
                            BlockNumber num_all_visible_pages,
                            bool hasindex, TransactionId frozenxid,
                            MultiXactId minmulti,
                            bool in_outer_xact)
        {
        Oid			relid = RelationGetRelid(relation);
        ```

#### 引数

| プロパティ名<br />（論理名） | プロパティ名<br />（物理名） | 型               | 型の備考 | IN/OUT | 省略指定 | 値の範囲 |
| ---------------------------- | ---------------------------- | ---------------- | -------- | ------ | -------- | -------- |
| テーブルID                   | table_id                   | int64_t |          | IN     | 省略不可 | 1以上  |
| 行数                         | reltuples                    | float         |          | IN     | 省略不可 | 型の範囲 |

#### 戻り値

| プロパティ名（論理名） | 型        | 値の範囲                                                     |
| ---------------------- | --------- | ------------------------------------------------------------ |
| エラーコード           | ErrorCode | ErrorCode::OK：正常<br />ErrorCode::INVALID_PARAMETER：引数に、存在しないテーブルIDが入力された。<br/>ErrorCode::DATABASE_ACCESS_FAILURE：メタデータ格納先に障害が発生した。|

#### 条件

* 事前条件

  * 引数に、テーブルID、行数が指定されている。
* 事後条件

  * 戻り値として、ErrorCodeを返す。



#### 処理詳細

1. metadata-managerは、事前条件に基づき、引数の入力規則チェックを実施する。
  * テーブルID < 0の場合
    * metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。
2. メタデータ格納先はTransactionを開始する。
3. metadata-managerは、引数table_id、reltuplesを基に、Tableメタデータテーブル【tsurugi_class】の列reltuplesを更新する。
4. 3.でレコードの登録・更新に成功した場合
   1. メタデータ格納先は、commit処理を行い、Transactionを終了する。
   2. metadata-managerは、戻り値にErrorCode::OKを設定し、処理を終了する。
5. 3.でレコードの登録・更新に失敗した場合
   
   1. メタデータ格納先は、rollback処理を行い、Transactionを終了する。
   
   2. metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。

### 1テーブルの表統計登録・更新（input：テーブル名・行数、output：テーブルID）

#### 処理概要

* metadata-managerは、メタデータ格納先に対して、**1テーブル単位の表統計**を登録・更新する。

* 登録・更新の単位を、1テーブル単位の表統計としている理由
  * PostgreSQLの次のソースコードを参考にした。
    * postgresql-12.3/src/backend/commands/vacuum.c
      * PostgreSQLの場合、表統計登録・更新APIは、引数としてテーブルIDを含むRelation構造体・行数num_tuplesが指定される。
      
        ```C
        /*
         *	vac_update_relstats() -- update statistics for one relation
        （略）
         */
        void
        vac_update_relstats(Relation relation,
                            BlockNumber num_pages, double num_tuples,
                            BlockNumber num_all_visible_pages,
                            bool hasindex, TransactionId frozenxid,
                            MultiXactId minmulti,
                            bool in_outer_xact)
        {
        Oid			relid = RelationGetRelid(relation);
        ```

#### 引数

| プロパティ名<br />（論理名） | プロパティ名<br />（物理名） | 型               | 型の備考 | IN/OUT | 省略指定 | 値の範囲 |
| ---------------------------- | ---------------------------- | ---------------- | -------- | ------ | -------- | -------- |
| テーブル名                   | table_name                   | std::string_view |          | IN     | 省略不可 | 1桁以上  |
| 行数                         | reltuples                    | float         |          | IN     | 省略不可 | 型の範囲 |
| テーブルID | table_id                    | int64_t*       | **ポインタ** | OUT     | 省略可  | 型の範囲 |

#### 戻り値

| プロパティ名（論理名） | 型        | 値の範囲                                                     |
| ---------------------- | --------- | ------------------------------------------------------------ |
| エラーコード           | ErrorCode | ErrorCode::OK：正常<br />ErrorCode::INVALID_PARAMETER：引数に、存在しないテーブル名が入力された。<br/>ErrorCode::DATABASE_ACCESS_FAILURE：メタデータ格納先に障害が発生した。|

#### 条件

* 事前条件

  * 引数に、テーブルID、行数が指定されている。
* 事後条件

  * 戻り値として、ErrorCodeを返す。
  * 引数table_idに、列統計テーブル【tsurugi_class】に対して登録・更新が成功したレコードのテーブルIDを設定する。



#### 処理詳細

1. metadata-managerは、事前条件に基づき、引数の入力規則チェックを実施する。
  * テーブル名 = ""（空文字）
    * metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。
2. メタデータ格納先はTransactionを開始する。
3. metadata-managerは、引数table_name、reltuplesを基に、Tableメタデータテーブル【tsurugi_class】の列reltuplesを更新する。
4. 3.でレコードの登録・更新に成功した場合
   1. メタデータ格納先は、commit処理を行い、Transactionを終了する。
   2. metadata-managerは、引数table_idに、Tableメタデータテーブル【tsurugi_class】に対して登録・更新が成功したレコードのテーブルIDを設定する。
   3. metadata-managerは、戻り値にErrorCode::OKを設定し、処理を終了する。
5. 3.でレコードの登録・更新に失敗した場合
   
   1. メタデータ格納先は、rollback処理を行い、Transactionを終了する。
   
   2. metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。

### 1テーブルの全列統計参照（input：テーブルID）

#### 処理概要

* metadata-managerは、メタデータ格納先から、次のメタデータを一括で取得する。
  * 1テーブルに紐づく全カラムそれぞれのカラム番号とその列統計(std::unordered_map)

* 上記メタデータを一括で取得する理由
  * 「1カラムの列統計参照（input：テーブルID・カラム番号）」APIより、メタデータ格納先へのアクセス回数を減らし、メモリに展開して計算できるようにするため。

#### 引数

| プロパティ名（論理名）      | プロパティ名（物理名） | 型                 | 型の備考     | IN/OUT | 省略指定 | 値の範囲 |
| --------------------------- | ---------------------- | ------------------ | ------------ | ------ | -------- | -------- |
| テーブルID                  | table_id            | int64_t   |              | IN     | 省略不可 | 1以上  |
| 1テーブルに紐づく全カラムそれぞれのカラム番号とその列統計(std::unordered_map) | column_statistics | std::unordered_map<int64_t,ColumnStatistic>& | **参照渡し** | OUT    | 省略不可 | 型の範囲 |

#### 戻り値

| プロパティ名（論理名） | 型        | 値の範囲                                           |
| ---------------------- | --------- | -------------------------------------------------- |
| エラーコード           | ErrorCode | ErrorCode::OK：正常<br />ErrorCode::INVALID_PARAMETER：引数に存在しないテーブルIDが指定された |

#### 条件

* 事前条件

  * 引数に、テーブルIDが指定されている。

* 事後条件
  * 戻り値として、ErrorCodeを返す。
  * ErrorCode::OKの場合
    * column_statisticsに、1テーブルに紐づく全カラムそれぞれのカラム番号とその列統計(std::unordered_map)が格納される。
      * std::unordered_map型の値
        * key: カラム番号
        * value: ColumnStatistic

#### 処理詳細

1. metadata-managerは、事前条件に基づき、引数の入力規則チェックを実施する。
  * テーブルID < 0の場合
    * metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。
2. metadata-managerは、メタデータ格納先の列統計テーブル【tsurugi_statistic】から、テーブルIDが引数テーブルIDに一致する全レコードを取得する。
   * 一致するレコードの取得に成功した場合
     1. metadata-managerは、引数column_statisticsに、取得したレコードを設定する。
     2. metadata-managerは、戻り値にErrorCode::OKを設定し、処理を終了する。
   * それ以外の場合
     
     * metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。
     
       

### 1カラムの列統計参照（input：テーブルID・カラム番号）

#### 処理概要

* metadata-managerは、メタデータ格納先から、**1カラム単位の列統計**を取得する。
* 本APIを定義した理由
  * PostgreSQLの次のソースコードを参考にした。
    * postgresql-12.3/src/backend/utils/adt/selfuncs.c
    
      ```C
      /*
       * examine_variable
       *		Try to look up statistical data about an expression.
       *		Fill in a VariableStatData struct to describe the expression.
       （略）
       */
      void
      examine_variable(PlannerInfo *root, Node *node, int varRelid,
      				 VariableStatData *vardata)
      {
        （略）
      		vardata->rel = find_base_rel(root, var->varno);
          
          /* Try to locate some stats */
      		examine_simple_variable(root, var, vardata);
      ```
      
      * find_base_rel
        * 1テーブルの次のメタデータを取得
          * 行数
          * ページ数
      * examine_simple_variable
        * テーブルID・カラム番号・rte->inhを引数として、1カラムの列統計を取得している。


#### 引数

| プロパティ名（論理名）      | プロパティ名（物理名） | 型                 | 型の備考     | IN/OUT | 省略指定 | 値の範囲 |
| --------------------------- | ---------------------- | ------------------ | ------------ | ------ | -------- | -------- |
| テーブルID                  | table_id             | int64_t   |              | IN     | 省略不可 | 1以上 |
| カラム番号(1 origin)                    | ordinal_position           | int64_t   |              | IN     | 省略不可 | 1以上  |
| 1カラム単位の列統計          | column_statistic              | ColumnStatistic& | **参照渡し** | OUT    | 省略不可 | 型の範囲 |

#### 戻り値

| プロパティ名（論理名） | 型        | 値の範囲                                                     |
| ---------------------- | --------- | ------------------------------------------------------------ |
| エラーコード           | ErrorCode | ErrorCode::OK：正常<br />ErrorCode::INVALID_PARAMETER：引数に存在しないテーブルID・カラム番号が指定された |

#### 条件

* 事前条件

  * 引数に、テーブルID、カラム番号が指定されている。

* 事後条件
  * 戻り値として、ErrorCodeを返す。
  * ErrorCode::OKの場合
    * column_statisticに列統計の値が格納される。

#### 処理詳細

1. metadata-managerは、事前条件に基づき、引数の入力規則チェックを実施する。
  * テーブルID < 0 または　カラム番号 < 0
    * metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。
2. metadata-managerは、メタデータ格納先の列統計テーブル【tsurugi_statistic】から、テーブルID、カラム番号が、引数テーブルID、カラム番号それぞれに一致するレコードを取得する。
   * 一致するレコードの取得に成功した場合
     1. metadata-managerは、引数column_statisticに、取得したレコードを設定する。
     2. metadata-managerは、戻り値にErrorCode::OKを設定し、処理を終了する。
   * それ以外の場合
     * metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。


### 1テーブルの表統計参照（input：テーブルID）

#### 処理概要

* metadata-managerは、メタデータ格納先から、1テーブルに紐づく表統計と、Tableメタデータ全項目の値を取得する。

#### 引数

| プロパティ名（論理名）      | プロパティ名（物理名） | 型                 | 型の備考     | IN/OUT | 省略指定 | 値の範囲 |
| --------------------------- | ---------------------- | ------------------ | ------------ | ------ | -------- | -------- |
| テーブルID                  | table_id             | int64_t   |              | IN     | 省略不可 | 1以上  |
| 1テーブルに紐づく表統計と、Tableメタデータ全項目の値 | table_statistic | TableStatistic&             | **参照渡し** | OUT    | 省略不可 | 型の範囲 |

#### 戻り値

| プロパティ名（論理名） | 型        | 値の範囲                                                     |
| ---------------------- | --------- | ------------------------------------------------------------ |
| エラーコード           | ErrorCode | ErrorCode::OK：正常<br />ErrorCode::INVALID_PARAMETER：引数に存在しないテーブルIDが指定された |

#### 条件

* 事前条件

  * 引数に、テーブルIDが指定されている。

* 事後条件
  * 戻り値として、ErrorCodeを返す。
  * ErrorCode::OKの場合
    * table_statisticに、1テーブルに紐づく表統計と、Tableメタデータ全項目の値が格納される。

#### 処理詳細

1. metadata-managerは、事前条件に基づき、引数の入力規則チェックを実施する。
  * テーブルID < 0
    * metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。
2. metadata-managerは、メタデータ格納先のTableメタデータテーブル【tsurugi_class】から、テーブルIDが引数table_idに一致するレコードを取得する。
   * 一致するレコードの取得に成功した場合
     * metadata-managerは、引数table_statisticに、取得したレコードを設定し、処理を終了する。
   * それ以外の場合
     * metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。



### 1テーブルの表統計参照（input：テーブル名、output：テーブルID・行数）

#### 処理概要

* metadata-managerは、メタデータ格納先から、1テーブルに紐づく表統計と、Tableメタデータ全項目の値を取得する。

#### 引数

| プロパティ名（論理名）      | プロパティ名（物理名） | 型                 | 型の備考     | IN/OUT | 省略指定 | 値の範囲 |
| --------------------------- | ---------------------- | ------------------ | ------------ | ------ | -------- | -------- |
| テーブル名                  | table_name             | std::string_view   |              | IN     | 省略不可 | 1桁以上  |
| 1テーブルに紐づく表統計と、Tableメタデータ全項目の値 | table_statistic | TableStatistic&             | **参照渡し** | OUT    | 省略不可 | 型の範囲 |

#### 戻り値

| プロパティ名（論理名） | 型        | 値の範囲                                                     |
| ---------------------- | --------- | ------------------------------------------------------------ |
| エラーコード           | ErrorCode | ErrorCode::OK：正常<br />ErrorCode::INVALID_PARAMETER：引数に存在しないテーブル名が指定された |

#### 条件

* 事前条件

  * 引数に、テーブルIDが指定されている。

* 事後条件
  * 戻り値として、ErrorCodeを返す。
  * ErrorCode::OKの場合
    * table_statisticに、1テーブルに紐づく表統計と、Tableメタデータ全項目の値が格納される。

#### 処理詳細

1. metadata-managerは、事前条件に基づき、引数の入力規則チェックを実施する。
  * テーブル名 = ""（空文字）
    * metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。
2. metadata-managerは、メタデータ格納先のTableメタデータテーブル【tsurugi_class】から、テーブルIDが引数table_nameに一致するレコードを取得する。
   * 一致するレコードの取得に成功した場合
     * metadata-managerは、引数table_statisticに、取得したレコードを設定し、処理を終了する。
   * それ以外の場合
     * metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。



### 1テーブルの全列統計削除（input：テーブルID）

#### 処理概要

* metadata-managerは、メタデータ格納先から、**1テーブルに紐づく列統計の全レコード**を削除する。
* 本APIを定義した理由
  * DROP TABLE機能から、本APIを呼ぶ想定のため。

#### 引数

| プロパティ名（論理名） | プロパティ名（物理名） | 型               | IN/OUT | 省略指定 | 値の範囲 |
| ---------------------- | ---------------------- | ---------------- | ------ | -------- | -------- |
| テーブルID             | table_id             | int64_t | IN     | 省略不可 | 1以上  |

#### 戻り値

| プロパティ名（論理名） | 型        | 値の範囲                                                     |
| ---------------------- | --------- | ------------------------------------------------------------ |
| エラーコード           | ErrorCode | ErrorCode::OK：正常<br />ErrorCode::INVALID_PARAMETER：引数に存在しないテーブルIDが指定された<br/>ErrorCode::DATABASE_ACCESS_FAILURE：メタデータ格納先に障害が発生した。|

#### 条件

* 事前条件
  * 引数に、テーブルIDが指定されている。
* 事後条件
  * 戻り値として、ErrorCodeを返す。

#### 処理詳細

1. metadata-managerは、事前条件に基づき、引数の入力規則チェックを実施する。
  * テーブルID < 0
    * metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。
2. メタデータ格納先は、Transactionを開始する。
3. metadata-managerは、メタデータ格納先の列統計テーブル【tsurugi_statistic】から、テーブルIDが引数table_idに一致する全レコードを削除する。
4. 3.でレコードの削除に成功した場合
   1. メタデータ格納先は、commit処理を行い、Transactionを終了する。
   2. metadata-managerは、戻り値にErrorCode::OKを設定し、処理を終了する。
5. 3.でレコードの削除に失敗した場合
   1. メタデータ格納先は、rollback処理を行い、Transactionを終了する。
   2. metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。


### 1カラムの列統計削除（input：テーブルID・カラム番号）

#### 処理概要

* metadata-managerは、メタデータ格納先から、**1カラムの列統計**を削除する。
* 本APIを定義した理由
  * ALTER TABLE機能から、本APIを呼ぶ想定のため。
  * PostgreSQLの次の関数を参考にした。
    * postgresql-12.3/src/backend/catalog/heap.c
    
      ```C
      /*
      * RemoveStatistics --- remove entries in pg_statistic for a rel or column
      *
      * If attnum is zero, remove all entries for rel; else remove only the one(s)
      * for that column.
      */
      void
      RemoveStatistics(Oid relid, AttrNumber attnum)
      ```

#### 引数

| プロパティ名（論理名） | プロパティ名（物理名） | 型               | IN/OUT | 省略指定 | 値の範囲 |
| ---------------------- | ---------------------- | ---------------- | ------ | -------- | -------- |
| テーブルID             | table_id             | int64_t | IN     | 省略不可 | 1以上  |
| カラム番号(1 origin)             | ordinal_position           | int64_t | IN     | 省略不可 | 1以上  |

#### 戻り値

| プロパティ名（論理名） | 型        | 値の範囲                                                     |
| ---------------------- | --------- | ------------------------------------------------------------ |
| エラーコード           | ErrorCode | ErrorCode::OK：正常<br />ErrorCode::INVALID_PARAMETER：引数に存在しないテーブルID・カラム番号が指定された。<br/>ErrorCode::DATABASE_ACCESS_FAILURE：メタデータ格納先に障害が発生した。 |

#### 条件

* 事前条件
  * 引数に、テーブルID・カラム番号が指定されている。
* 事後条件
  * 戻り値として、ErrorCodeを返す。

#### 処理詳細

1. metadata-managerは、事前条件に基づき、引数の入力規則チェックを実施する。
  * テーブルID < 0 または カラム番号 < 0
    * metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。
2. メタデータ格納先は、Transactionを開始する。
3. metadata-managerは、メタデータ格納先の列統計テーブル【tsurugi_statistic】から、テーブルID・カラム番号が引数テーブルID、カラム番号に一致するレコードを削除する。
4. 3.でレコードの削除に成功した場合
   1. メタデータ格納先は、commit処理を行い、Transactionを終了する。
   2. metadata-managerは、戻り値にErrorCode::OKを設定し、処理を終了する。
5. 3.でレコードの削除に失敗した場合
   1. メタデータ格納先は、rollback処理を行い、Transactionを終了する。
   2. metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。

## エラーコード一覧
|エラーコード|説明|
|---|---|
|OK|正常|
|INVALID_PARAMETER|引数に不正なパラメーターが入力された。metadata-managerのAPIを利用するコンポーネントに問題があり、<br/>metadata-managerのAPIに入力するパラメーターを修正する必要がある可能性が高い。<br/>・UPDATE/INSERT/UPSERT文の発行に失敗：メタデータ格納先のテーブルに対して、制約に違反するレコードの登録・更新を行った。<br/>存在しないテーブルID（またはテーブル名）またはカラム番号のレコードの更新を行った。<br/>・DELETE文の発行に失敗：メタデータ格納先のテーブルに対して、存在しないテーブルID（またはテーブル名）またはカラム番号のレコードの削除を行った。<br/>・SELECT文の発行に失敗：メタデータ格納先のテーブルに対して、存在しないテーブルID（またはテーブル名）またはカラム番号のレコードの参照を行った。<br/>・または、メタデータ格納先に障害が発生した。|
|DATABASE_ACCESS_FAILURE|メタデータ格納先に障害が発生した。メタデータ格納先（データベース）周りに問題があり、<br/>metadata-managerのAPIを利用するコンポーネントは処理を続行できない可能性が高い。<br/>・初期化処理に失敗した場合（コネクションの確立、またはセキュアなサーチパスの設定に失敗、またはプリペアードステートメントの前処理の実行に失敗）<br/>・トランザクションの開始に失敗<br/>・コミット失敗<br/>・ロールバック失敗|
|INTERNAL_ERROR|API側のエラー（メモリ確保エラーやファイル作成エラーなど）|


## ログ

* metadata-managerは、metadata-manager V2.0と同等レベルで、標準エラー出力を行う。



以上
