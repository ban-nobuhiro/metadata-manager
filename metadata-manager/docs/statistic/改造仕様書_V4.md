【Project-Tsurugi Intern User Only】

# 統合メタデータ管理基盤 統計情報管理機能 改造仕様書

2021.08.24 初版 NEC  
2021.08.27 1.1.1版 NEC  
2021.08.31 1.2版 NEC

<!-- TOC -->

- [統合メタデータ管理基盤 統計情報管理機能 改造仕様書](#%E7%B5%B1%E5%90%88%E3%83%A1%E3%82%BF%E3%83%87%E3%83%BC%E3%82%BF%E7%AE%A1%E7%90%86%E5%9F%BA%E7%9B%A4-%E7%B5%B1%E8%A8%88%E6%83%85%E5%A0%B1%E7%AE%A1%E7%90%86%E6%A9%9F%E8%83%BD-%E6%94%B9%E9%80%A0%E4%BB%95%E6%A7%98%E6%9B%B8)
  - [現バージョンV3の問題点](#%E7%8F%BE%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3v3%E3%81%AE%E5%95%8F%E9%A1%8C%E7%82%B9)
  - [修正方針案](#%E4%BF%AE%E6%AD%A3%E6%96%B9%E9%87%9D%E6%A1%88)
  - [外部設計](#%E5%A4%96%E9%83%A8%E8%A8%AD%E8%A8%88)
    - [テーブルメタデータオブジェクト（Tables）](#%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%83%A1%E3%82%BF%E3%83%87%E3%83%BC%E3%82%BF%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88tables)
      - [テーブルメタデータオブジェクト例（JSON形式でのイメージ）](#%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%83%A1%E3%82%BF%E3%83%87%E3%83%BC%E3%82%BF%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E4%BE%8Bjson%E5%BD%A2%E5%BC%8F%E3%81%A7%E3%81%AE%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8)
    - [統計情報オブジェクト（Statistics）](#%E7%B5%B1%E8%A8%88%E6%83%85%E5%A0%B1%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88statistics)
      - [統計情報オブジェクト例（JSON形式でのイメージ）](#%E7%B5%B1%E8%A8%88%E6%83%85%E5%A0%B1%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E4%BE%8Bjson%E5%BD%A2%E5%BC%8F%E3%81%A7%E3%81%AE%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8)
    - [メソッド](#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89)
    - [Tablesクラスメソッド ※変更分のみ](#tables%E3%82%AF%E3%83%A9%E3%82%B9%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89-%E2%80%BB%E5%A4%89%E6%9B%B4%E5%88%86%E3%81%AE%E3%81%BF)
      - [Tables::get_all](#tablesget_all)
      - [Tables::get_statistic](#tablesget_statistic)
      - [Tables::set_statistic](#tablesset_statistic)
    - [Statisticsクラスメソッド](#statistics%E3%82%AF%E3%83%A9%E3%82%B9%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89)
      - [Statistics::get](#statisticsget)
      - [Statistics::get_all](#statisticsget_all)
      - [Statistics::get_by_column_id](#statisticsget_by_column_id)
      - [Statistics::get_by_column_number](#statisticsget_by_column_number)
      - [Statistics::get_by_column_name](#statisticsget_by_column_name)
      - [Statistics::add](#statisticsadd)
  - [内部設計](#%E5%86%85%E9%83%A8%E8%A8%AD%E8%A8%88)
    - [DBテーブル](#db%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB)
      - [テーブルメタデータテーブル](#%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%83%A1%E3%82%BF%E3%83%87%E3%83%BC%E3%82%BF%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB)
      - [統計情報テーブル](#%E7%B5%B1%E8%A8%88%E6%83%85%E5%A0%B1%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB)
  - [付録](#%E4%BB%98%E9%8C%B2)
    - [A. Boost Property Treeを採用する理由](#a-boost-property-tree%E3%82%92%E6%8E%A1%E7%94%A8%E3%81%99%E3%82%8B%E7%90%86%E7%94%B1)
    - [B. Boost Property TreeとJSONの対応](#b-boost-property-tree%E3%81%A8json%E3%81%AE%E5%AF%BE%E5%BF%9C)
      - [JSON形式とProperty Tree形式の変換例](#json%E5%BD%A2%E5%BC%8F%E3%81%A8property-tree%E5%BD%A2%E5%BC%8F%E3%81%AE%E5%A4%89%E6%8F%9B%E4%BE%8B)
      - [Property Treeのアクセス方法](#property-tree%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E6%96%B9%E6%B3%95)
    - [C. PostgreSQLデータ型とC++データ型の対応関係](#c-postgresql%E3%83%87%E3%83%BC%E3%82%BF%E5%9E%8B%E3%81%A8c%E3%83%87%E3%83%BC%E3%82%BF%E5%9E%8B%E3%81%AE%E5%AF%BE%E5%BF%9C%E9%96%A2%E4%BF%82)
      - [数値データ型](#%E6%95%B0%E5%80%A4%E3%83%87%E3%83%BC%E3%82%BF%E5%9E%8B)
    - [D. PostgreSQLのStatisticsクラス](#d-postgresql%E3%81%AEstatistics%E3%82%AF%E3%83%A9%E3%82%B9)
      - [pg_statsview](#pg_statsview)
      - [pg_statistic](#pg_statistic)
    - [E. V1でMetadataクラスのメソッドを純粋仮想関数にしなかった理由](#e-v1%E3%81%A7metadata%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AE%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E7%B4%94%E7%B2%8B%E4%BB%AE%E6%83%B3%E9%96%A2%E6%95%B0%E3%81%AB%E3%81%97%E3%81%AA%E3%81%8B%E3%81%A3%E3%81%9F%E7%90%86%E7%94%B1)
    - [F. 案２の統計情報オブジェクト](#f-%E6%A1%88%EF%BC%92%E3%81%AE%E7%B5%B1%E8%A8%88%E6%83%85%E5%A0%B1%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88)
      - [表統計情報オブジェクト（TableStatistics）](#%E8%A1%A8%E7%B5%B1%E8%A8%88%E6%83%85%E5%A0%B1%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88tablestatistics)
        - [表統計情報オブジェクト例（JSON形式でのイメージ）](#%E8%A1%A8%E7%B5%B1%E8%A8%88%E6%83%85%E5%A0%B1%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E4%BE%8Bjson%E5%BD%A2%E5%BC%8F%E3%81%A7%E3%81%AE%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8)
      - [列統計情報オブジェクト（ColumnStatistics）](#%E5%88%97%E7%B5%B1%E8%A8%88%E6%83%85%E5%A0%B1%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88columnstatistics)
        - [列統計情報オブジェクト例（JSON形式でのイメージ）](#%E5%88%97%E7%B5%B1%E8%A8%88%E6%83%85%E5%A0%B1%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E4%BE%8Bjson%E5%BD%A2%E5%BC%8F%E3%81%A7%E3%81%AE%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8)
    - [G. 案３の統計情報オブジェクト](#g-%E6%A1%88%EF%BC%93%E3%81%AE%E7%B5%B1%E8%A8%88%E6%83%85%E5%A0%B1%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88)
      - [統計情報オブジェクト例（JSON形式によるイメージ）](#%E7%B5%B1%E8%A8%88%E6%83%85%E5%A0%B1%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E4%BE%8Bjson%E5%BD%A2%E5%BC%8F%E3%81%AB%E3%82%88%E3%82%8B%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8)

<!-- /TOC -->

## 現バージョン(V3)の問題点

1. Statisticsクラスのメソッド名が基底クラス(Metadata)の方針に沿っていない

    - 1つのクラスで複数のメタデータ（表統計情報、列統計情報）を扱っている。
    - 基本方針は1クラス、1メタデータ
    - 基本的なメソッド(get, add)が実装されていない

1. Tablesクラスのすべてのオブジェクトを取得する手段が提供されていない

    - 以前はload()やnext()といった手段が提供されていた。

## 修正方針案

おもに問題点１の修正案として以下の３つの案が考えられる。

- 案１：統計情報クラス(Statistics)では列統計情報クラスのみ扱い、表統計情報はTableクラス(Tables)で扱う
- 案２：統計情報クラス(Statistics)を表統計情報クラス(TableStatistics)と列統計情報クラス(ColumnStatistics)に分ける
- 案３：表統計情報と列統計情報を1つの統計情報クラスにまとめる

案１では、Statisticsクラスで扱う統計情報を列統計情報のみとし、表統計情報はTableクラスで扱うように変更する。現状、**表統計情報は行数情報のみ**のため簡便性を優先してテーブルメタデータに含める。将来、表統計情報の種類が増えてきた場合は、案１か案２を検討する。Tableクラスにはあらたに表統計情報を扱うメソッドを追加する。この案では、1つの表に関する統計情報（表統計情報と列統計情報）を取得するために最低でも２回のメソッド呼び出し（DBアクセス）が必要となる。

案２では、既存のStatisticsクラスを廃止し、**表統計情報クラスと列統計情報クラスに分ける**。この案では、1つの表に関する統計情報（表統計情報と列統計情報）を取得するために最低でも２回のメソッド呼び出し（DBアクセス）が必要となる（現バージョンと同じ）。

案３では、表統計情報と列統計情報を1つのクラスにまとめて返す。この案では１つの表に関する統計情報を取得するために１回のメソッド呼び出し（DBアクセス）で済む。ただし、**クライアント側で統計情報クラスから表統計情報や列統計情報を別途取り出す（Property Treeのノード操作）処理が必要となる**。そのため、特定の列の統計情報のみが必要な場合は既存のメソッド（get_one_column_statisticなど）を利用可能とする。

どの案であっても大きな違いはないと考えるが、設計をシンプルにするために今回は案１を選択する。

## 外部設計

### テーブルメタデータオブジェクト（Tables）

| # | キー名 | データ型 | 説明 | 採番 | add | 備考 |
|---|---|---|---|---|---|---|
| 1. | format_version*  | int32_t | オブジェクトのフォーマットバージョン。  | ○ | -   | -  |
| 2. | generation*      | int64_t | メタデータの世代。                      | ○ | -   | 現状"1"固定。 |
| 3. | id*              | int64_t | テーブルオブジェクトのOID。             | ○ | -   | -  |
| 4. | name*            | string  | テーブル名。                            | -  | ○  | -  |
| 5. | namespace        | string  | 名前空間名（スキーマ名）。              | -  | -   | -  |
| 6. | primary_keys     | json    | プライマリキーのカラム番号。            | -  | -   | 複数指定可。 |
| 6. | tuples           | float   | テーブルの推定行数。                    | -  | -   | 新規追加。   |
| 7. | columns          | Node    | 列メタデータオブジェクト群 。           | -  | ○  | 説明は省く。 |

- *はすべてのメタデータオブジェクトに含まれるパラメータであることを示す。
- "採番"の項目は統合メタデータ管理基盤で自動採番される。
- "add"はaddメソッド実行時に入力が必須の項目。

#### テーブルメタデータオブジェクト例（JSON形式でのイメージ）

- 例１）すべての項目を設定した場合
  - addメソッド実行時

    ```text
    {
      "name": "PUBLIC.foo", 
      "namespace": "PUBLIC", 
      "primary_keys": [1,2], 
      "tuples": 231000, 
      "columns": [
        {...}, 
        {...}, 
        {...}
      ]
    }
    ```

  - getメソッド実行時

    ```text
    {
      "format_version": 1, 
      "generation": 1, 
      "id": 3, 
      "name": "PUBLIC.foo", 
      "namespace": "PUBLIC", 
      "primary_keys": [1,2], 
      "tuples": 231000, 
      "columns": [
        {...}, 
        {...}, 
        {...}
      ]
    }
    ```

- 例２）最低限の項目を設定した場合
  - addメソッド実行時

    ```text
    {
      "name": "PUBLIC.foo", 
      "columns": [
      ]
    }
    ```

  - getメソッド実行時

    ```text
    {
      "format_version": 1, 
      "generation": 1, 
      "id": 3, 
      "name": "PUBLIC.foo", 
      "namespace": "", 
      "primary_keys": [], 
      "tuples": 0, 
      "columns": [
      ]
    }
    ```

- 例３）get_statisticメソッド実行時

  ```text
  {
    "format_version": 1, 
    "generation": 1, 
    "id": 3, 
    "name": "PUBLIC.foo", 
    "namespace": "PUBLIC",
    "tuples": 231000, 
  }
  ```

### 統計情報オブジェクト（Statistics）

| # | キー名 | データ型 | 説明 | 採番 | add | 備考 |
|---|---|---|---|---|---|---|
| 1.| format_version*  | int32_t | オブジェクトのフォーマットバージョン。| ○ | -    | -  |
| 2.| generation*      | int64_t | メタデータの世代。                    | ○ | -    | 現状"1"固定。   |
| 3.| id*              | int64_t | カラム統計情報オブジェクトのOID。     | ○ | -    | -  |
| 4.| name*            | string  | カラム統計情報オブジェクト名。        | -  | -    | 任意の名前を設定可能。 |
| 5.| table_id         | int64_t | カラムが属するテーブルのOID。         | -  | ○   | -  |
| 6.| ordinal_position | int64_t | カラム番号。                          | -  | △   | 1 origin。  |
| 7.| column_id        | int64_t | カラムOID。                           | -  | △   | -  |
| 8.| column_name      | string  | カラム名。                            | -  | -    | -  |
| 9.| column_statistic | json    | 列統計情報。                          | -  | -    | -  |

- *はすべてのメタデータオブジェクトに含まれるパラメータであることを示す。
- "採番"の項目は統合メタデータ管理基盤で自動採番される。
- "add"はaddメソッド実行時に入力が必須の項目。
- "column_id"または"ordinal_position"は選択必須。

#### 統計情報オブジェクト例（JSON形式でのイメージ）

- 例１）すべての項目を設定した場合
  - addメソッド実行時

    ```text
    {
      "name": "PUBLIC.foo.col1.stat", 
      "table_id": 2, 
      "ordinal_position": 1, 
      "column_id": 32, 
      "column_name": "col1", 
      "column_statistic": {...}
    }
    ```

  - getメソッド実行時

    ```text
    {
      "format_version": 1, 
      "generation": 1,
      "id": 3, 
      "name": "PUBLIC.foo.col1.stat", 
      "table_id": 2, 
      "ordinal_position": 1, 
      "column_id": 32, 
      "column_name": "col1", 
      "column_statistic": {...}
    }
    ```

- 例２）最低限の項目kを設定した場合
  - addメソッド実行時

    ```text
    {
      "table_id": 2, 
      "column_name": "col1", 
      "ordinal_position": 1, 
      "column_statistic": {...}
    }
    ```

  - getメソッド実行時

    ```text
    {
      "format_version": 1, 
      "generation": 1, 
      "id": 3, 
      "name": "", 
      "table_id": 2, 
      "ordinal_position": 1, 
      "column_id": 0, 
      "column_name": "", 
      "column_statistic": {...}
    }
    ```

### メソッド

- 既存(V3)のgetメソッド
  - Statisticsクラス
    - get_table_statistic(table_id, table_statistic)
    - get_table_statistic(table_name, table_statistic)
    - get_one_column_statistic(table_id, column_number, column_statistic)
    - get_all_column_statistics(table_id, column_statistics)

### Tablesクラスメソッド ※変更分のみ

#### Tables::get_all

- 書式

  `get_all(std::vector<boost::property_tree::ptree>& objects)`

- 概要

  統合メタデータ管理基盤上のすべてのテーブルメタデータオブジェクトをコンテナに格納して返す。

- パラメータ

  - objects

    テーブルメタデータオブジェクトを格納したコンテナ。

- 戻り値

  - ErrorCode::OK

    成功。

  - ErrorCode::OK以外

    失敗。

---

#### Tables::get_statistic

- 書式

  `get_statistic(const ObjectIdType object_id, boost::property_tree::ptree& ptree)`  
  `get_statistic(std::string_view object_name, boost::property_tree::ptree& ptree)`

- 概要

  指定されたオブジェクトIDまたはオブジェクト名を持つ表統計情報オブジェクトを返す。

- パラメータ

  - object_id

    テーブルメタデータオブジェクトのオブジェクトID。

  - ptree

    表統計情報オブジェクト。

- 戻り値

  - ErrorCode::OK

    成功。

  - ErrorCode::OK以外

    失敗。

---

#### Tables::set_statistic

- 書式

  `set_statistic(boost::property_tree::ptree& ptree)`

- 概要

  表統計情報オブジェクトを更新する。

- パラメータ

  - ptree

    更新する表統計情報オブジェクト。

- 戻り値

  - ErrorCode::OK

    成功。

  - ErrorCode::OK以外

    失敗。

---

### Statisticsクラスメソッド

#### Statistics::get

- 書式

  `get(const ObjectIdType object_id, boost::property_tree::ptree& ptree)`  
  `get(std::string_view object_name, boost::property_tree::ptree ptree)`  

- 概要

  指定されたパラメータに一致する統計情報オブジェクトを返す。

- パラメータ

  - object_id

    統計情報オブジェクトのオブジェクトID。

  - ptree

    統計情報オブジェクト。

- 戻り値

  - ErrorCode::OK

    成功。

  - ErrorCode::OK以外

    失敗。

---

#### Statistics::get_all

- 書式

  `get_all(std::vecotr<boost::property_tree::ptree>& objects)`  
  `get_all(ObjectIdType table_id, std::vecotr\<boost::property_tree::ptree> objects)`  

- 概要

  統合メタデータ管理基盤上のすべての統計情報オブジェクト、または指定されたテーブルIDを持つ統計情報オブジェクトを返す。

- パラメータ

  - table_id

    テーブルオブジェクトのオブジェクトID。

  - objects

    統計情報オブジェクトのコンテナ。

- 戻り値

  - ErrorCode::OK

    成功。

  - ErrorCode::OK以外

    失敗。

---

#### Statistics::get_by_column_id

- 書式

  `get_by_column_id(const ObjectIdType column_id, boost::property_tree::ptree ptree)`  

- 概要

  指定されたカラムIDを持つ統計情報オブジェクトを返す。

- パラメータ

  - column_id

    カラムオブジェクトのオブジェクトID。

  - ptree

    統計情報オブジェクトのコンテナ。

- 戻り値

  - ErrorCode::OK

    成功。

  - ErrorCode::OK以外

    失敗。

---

#### Statistics::get_by_column_number

- 書式

  `get_by_column_number(const ObjectIdType table_id, const uint64_t column_number, boost::property_tree::ptree ptree)`  

- 概要

  指定されたテーブルID、カラム番号を持つ統計情報オブジェクトを返す。

- パラメータ

  - table_id

    テーブルメタデータオブジェクトのオブジェクトID。

  - column_number

    カラムメタデータオブジェクトのカラム番号(ordinal_position)。

  - ptree

    統計情報オブジェクト。

- 戻り値

  - ErrorCode::OK

    成功。

  - ErrorCode::OK以外

    失敗。

---

#### Statistics::get_by_column_name

- 書式

  `get_by_column_name(const ObjectIdType table_id, std::string_view column_name, boost::property_tree::ptree ptree)`  

- 概要

  指定されたテーブルID、カラム名を持つ統計情報オブジェクトを返す。

- パラメータ

  - table_id

    テーブルメタデータオブジェクトのオブジェクトID。

  - column_name

    カラムメタデータオブジェクトのオブジェクト名（カラム名）。

  - ptree

    統計情報オブジェクト。

- 戻り値

  - ErrorCode::OK

    成功。

  - ErrorCode::OK以外

    失敗。

---

#### Statistics::add

- 書式

  `add(boost::property_tree::ptree object)`

- 概要

  統計情報オブジェクトを追加する。

- パラメータ

  - object

    統計情報オブジェクト。

- 戻り値

  - ErrorCode::OK

    成功。

  - ErrorCode::OK以外

    失敗。

---

## 内部設計

### DBテーブル

#### テーブルメタデータテーブル

テーブル統計情報はTableメタデータテーブルに格納する。  

テーブル名：tsurugi_class

（変更点）

- 名前の命名規則をsnake_caseに変更。

| # | 名前 | 型 | 主キー | 参照先 | NOT NULL | 説明 |
|---|---|---|---|---|---|---|
| 1.| format_version  | integer   |- |- |○ | テーブルのOID。  |
| 2.| generation      | bigint    |- |- |○ | テーブル名。     |
| 3.| id              | bigserial |○|- |○ | テーブルのOID。  |
| 4.| name            | text      |- |- |○ | テーブル名。     |
| 5.| namespace       | text      |- |- |-  | 名前空間名（スキーマ名）。   |
| 6.| primary_key     | json      |- |- |-  | プライマリキーのカラム番号。bigintの配列を想定する。 |
| 7.| reltuples       | real      |- |- |-  | テーブルの推定行数。|

#### 統計情報テーブル

テーブル名：tsurugi_statistics

（変更点）

- 名前の命名規則をsnake_caseに変更
- format_version, generation, name, column_id, column_nameを追加
- oridinal_positionのNOT NULL誓約を解除

| # | 名前 | 型 | 主キー | 参照先 | NOT NULL | 説明 |
|---|---|---|---|---|---|---|
| 1.| format_version    | integer   |- |- |○ | フォーマットバージョン。    |
| 2.| generation        | integer   |- |- |○ | メタデータ世代。            |
| 3.| id                | bigserial |○|- |○ | 統計情報オブジェクトのOID。 |
| 4.| name              | text      |- |- |○ | 統計情報オブジェクト名。任意の名前。|
| 5.| table_id          | bigint    |- |- |○ | テーブルのOID。             |
| 6.| column_id         | bigint    |- |- |-  | カラムのOID。               |
| 7.| column_statistic  | json      |- |- |-  | カラム統計情報。            |

## 付録

### A. Boost Property Treeを採用する理由

統合メタデータ管理基盤のようなデータを管理するコンポーネントでは、クライアントへのデータの受け渡し方法として以下のようなものが考えられる。

  1. 構造体（クラス）にデータを格納し、API経由で受け渡す
  2. 共有メモリやパイプといったプロセス間通信を利用してデータを受け渡す
  3. REST APIのようなHTTPを利用してデータを受け渡す

このうち2.の方法については、クライアント側でデータを受け取るための処理を記述する必要があり、データの受け渡し方法が煩雑になる。そのため幅広いクライアントが想定される統合メタデータ管理基盤のインタフェースとしては不採用とする。

3.の方法はおもに受け渡し側（サーバ）と受け取り側（クライアント）間にネットワークを挟むことが想定される。ローカルからもリモートからも同じインタフェースでデータの受け渡しができるため、汎用性の高い方法といえる。

1.の方法については、データの受け渡し方法として一般的な方法であるが、この方法ではAPIとクライアント側で構造体（クラス）の仕様が一致している必要がある。受け渡しに用いる構造体（クラス）の仕様に変更が生じた場合は、クライアントのリビルドが必要になる。

統合メタデータ管理基盤はおもにOLTP上で動作し、OLTPとOLAP(リモートのケースもある)の各コンポーネントにメタデータ情報を提供する。そのように考えると1.の方法、3.の方法のどちらも適性があると言える。ただ、Tsurugiではプログラミング言語としてC/C++が採用されており、それらとの親和性を考慮するとまずは1.の方法でインタフェースを実装するのが妥当と考える。

統合メタデータ管理基盤で扱うメタデータの構造は今後も頻繁に変更される可能性があるため、1.の方法が持つ上記の問題点について対策する必要があると考える。解決方法として、Boost Property Tree(以下Property Treeと呼ぶ)を用いて、統合メタデータ管理基盤とクライアント間のインタフェースを一定に保ったまま、各メタデータの構造を柔軟に変更できる方法を採用する。

Property Treeを採用するメリット／デメリット配下のとおりである。

- メリット
  - メタデータオブジェクト（メタデータの集合）のデータ構造を変更した場合でもクライアントのリビルドが不要
  - 統合メタデータ管理基盤とクライアント間のインタフェースを一定に保ちやすい

- デメリット
  - クライアント側でProperty Treeから実際のデータを取り出す処理を記述する必要がある
    - 特に複雑な構造（入れ子構造など）のProperty Treeの場合は、子Nodeを辿るような処理を記述する必要がある
  - クライアント側があらかじめProperty Treeの構造を知っている必要がある

クライアント側から上記デメリットの改善要求が大きくなった場合は、従来通りの構造体（クラス）によるデータの受け渡しを検討する。

### B. Boost Property TreeとJSONの対応

[How to Populate a Property Tree](https://www.boost.org/doc/libs/1_77_0/doc/html/property_tree/parsers.html#property_tree.parsers.json_parser)

プロパティツリーデータセットは型付けされておらず、配列をサポートしていません。そのため、以下のようなJSONとプロパティツリーのマッピングが使用されています。

- JSON オブジェクトはノードにマッピングされます。各プロパティは子ノードです。
- JSON 配列は、ノードにマッピングされます。各要素は、空の名前を持つ子ノードです。ノードに名前付きと名前なしの両方の子ノードがある場合は、JSON表現にマッピングできません。
- JSONの値は、その値を含むノードにマッピングされます。ただし、すべての型情報は失われます。数字やリテラルの「null」、「true」、「false」は、単に文字列形式にマッピングされます。
- 子ノードとデータの両方を含むプロパティ ツリー ノードは、マッピングできません。

型情報が失われていることを除けば、JSONはラウンドトリップします。

#### JSON形式とProperty Tree形式の変換例

- JSON

  ```json
  {
    "menu":
    {
        "foo": true,
        "bar": "true",
        "value": 102.3E+06,
        "popup":
        [
          {"value": "New", "onclick": "CreateNewDoc()"},
          {"value": "Open", "onclick": "OpenDoc()"},
        ]
    }
  }
  ```

- Property Tree

  ```text
  menu
  {
    foo true
    bar true
    value 102.3E+06
    popup
    {
        ""
        {
          value New
          onclick CreateNewDoc()
        }
        ""
        {
          value Open
          onclick OpenDoc()
        }
    }
  }
  ```

#### Property Treeのアクセス方法

[How to Access Data in a Property Tree](<https://www.boost.org/doc/libs/1_77_0/doc/html/property_tree/accessing.html>)

### C. PostgreSQLデータ型とC++データ型の対応関係

前提条件

- 64bit CPU
- 64bit OS (Ubuntu 20.x LTS)

#### 数値データ型

| # | PostgreSQLデータ型 | サイズ | C++データ型 | サイズ | 値域(PG) | 備考 |
|---|---|---|---|---|---|---|
|1. | smallint  | 2バイト   | std::int16_t | 2バイト  | -32,768 -> +32,767                                       | - |
|2. | integer   | 4バイト   | std::int32_t | 4バイト  | -21,47,483,648 -> +2,147,483,647                         | - |
|3. | bigint    | 8バイト   | std::int64_t | 8バイト  | -9,223,372,036,854,775,808 -> 9,223,372,036,854,775,807  | - |
|4. | decimal   | 可変長    ||||-|
|5. | numeric   | 可変長    ||||-|
|6. | real              | 4バイト | std::float   | 4バイト  | 6桁精度   |-|
|7. | double\nprecision | 8バイト | std::double  | 8バイト  | 15桁精度  |-|
|8. | smallserial | 2バイト | std::int16_t  | 2バイト | 1 -> 32,767                     |- |
|9. | serial      | 4バイト | std::int32_t  | 4バイト | 1 -> 2,147,483,647              |- |
|10.| bigserial   | 8バイト | std::int64_t  | 8バイト | 1 -> 9,223,372,036,854,775,807  |- |

### D. PostgreSQLのStatisticsクラス

#### pg_stats(view)

<https://www.postgresql.jp/document/12/html/view-pg-stats.html>

人間が見ることを意識しているためか、以下の3つの情報で一意の列を表している。

- スキーマ名
- テーブル名
- 列名

#### pg_statistic

<https://www.postgresql.jp/document/12/html/catalog-pg-statistic-ext.html>

- 列が属するテーブルもしくはインデックスのoid
- 列番号

### E. V1でMetadataクラスのメソッドを純粋仮想関数にしなかった理由

理由：MetadataクラスのメソッドにTemplate Methodパターンを適用したため。

通常、今回のようなケースでは基底クラスであるMetdataクラスにget()などのメソッドを純粋仮想関数（インタフェース）として宣言し、各派生クラス（TableクラスやStatisticsクラス）でそれらのメソッドの処理を記述する。

```text
(基底クラス)
virtual Metadata::get() = 0;

(派生クラス)
Tables::get() {
  try {
    db.connect(db_name);
    query = "SELECT * FROM pg_table"; 
    db.dispatch_query(query);
    value = db.read();
    db.close();
  }
  catch(...) {
    ...
  }
  return value;  
}
Statistics::get() {
  try {
    db.connect(db_name);
    query = "SELECT * FROM pg_statistics";
    db.dispatch_query(query);
    value = db.read();
    db.close();
  }
  catch(...) {
    ...
  }
  return value;  
}
```

ただ、統合メタデータ管理基盤のような比較的単純な処理（データの読み書きなど）を行う場合は、各派生クラスでの処理が似たようなものになり、一部のパラメータ（DBの表名や列名など）の違いのみとなることが多い。そのようなケースでは、あらかじめ基底クラスで基本となる処理テンプレート（異常系を含む）を作成しておき、パラメータや処理が異なる部分のみを純粋仮想関数とすることによって派生クラスの作成が楽になる。

```text
(基底クラス)
virtual Metadata::get() {
  try {
    db.connect(db_name);
    query = create_query();
    db.dispatch_query(query);
    value = db.read();
    db.close();
  }
  catch(...) {
    ...
  }
  return value;
}
virtual std::string Metadata::create_query() = 0;

(派生クラス)
Tables::create_query() { query = "SELECT * FROM pg_table"; }
Statistics::create_query() { query = "SELECT * FROM pg_statistics"; }
```

### F. 案２の統計情報オブジェクト

#### 表統計情報オブジェクト（TableStatistics）

| # | キー名 | データ型 | 説明 | 採番 | add | 備考 |
|---|---|---|---|---|---|---|
| 1. | format_version*  | int64_t | オブジェクトのフォーマットバージョン。  | ○ | -    | -  |
| 2. | generation*      | int64_t | メタデータの世代。                      | ○ | -    | 現状"1"固定。 |
| 3. | id*              | int64_t | 表統計情報オブジェクトのOID。           | ○ | -    | -  |
| 4. | name*            | string  | 表統計情報オブジェクト名。              | -  | -    | 任意の名前を設定可能。 |
| 5. | table_id         | int64_t | テーブルのOID。                         | -  | △*1 | -  |
| 6. | table_name       | string  | テーブル名。                            | -  | △*1 | -  |
| 7. | table_tuples     | float   | テーブルの推定行数。                    | -  | -    | -  |

- *はすべてのメタデータオブジェクトに含まれるパラメータであることを示す。
- "採番"の項目はadd()メソッド実行時に値を入力しても無視される。
- "add"はaddメソッド実行時に入力が必須の項目。
- *1 table_id または table_nameの選択必須。

##### 表統計情報オブジェクト例（JSON形式でのイメージ）

- 例１）すべての項目を設定した場合
  - addメソッド実行時

    ```json
    {
      "name": "PUBLIC.foo", 
      "table_id": 2, 
      "table_name": "PUBLIC.foo", 
      "table_tuples": 231000
    }
    ```

  - getメソッド実行時

    ```json
    {
      "format_version": 1, 
      "generation": 1, 
      "id": 3, 
      "name": "PUBLIC.foo", 
      "table_id": 2, 
      "table_name": "PUBLIC.foo", 
      "table_tuples": 231000
    }
    ```

- 例２）最低限の項目を設定した場合
  - addメソッド実行時

    ```json
    {
      "table_name": "PUBLIC.foo", 
      "table_tuples": 231000
    }
    ```

  - getメソッド実行時

    ```json
    {
      "format_version": 1, 
      "generation": 1, 
      "id": 3, 
      "name": "", 
      "table_id": 0, 
      "table_name": "PUBLIC.foo", 
      "table_tuples": 231000
    }
    ```

#### 列統計情報オブジェクト（ColumnStatistics）

| # | キー名 | データ型 | 説明 | 採番 | add | 備考 |
|---|---|---|---|---|---|---|
| 1. | format_version*  | int64_t | オブジェクトのフォーマットバージョン。| ○ | -    |          |
| 2. | generation*      | int64_t | メタデータの世代。                    | ○ | -    | 現状"1"固定。   |
| 3. | id*              | int64_t | カラム統計情報オブジェクトのOID。     | ○ | -    | -  |
| 4. | name*            | string  | カラム統計情報オブジェクト名。        | -  | -    | 任意の名前を設定可能。 |
| 5. | table_id         | int64_t | カラムが属するテーブルのOID。         | -  | ○   | -  |
| 6. | column_id        | int64_t | カラムOID。                           | -  | △*1 | -  |
| 7. | column_name      | int64_t | カラム名。                            | -  | △*1 | -  |
| 8. | ordinal_position | int64_t | カラム番号。                          | -  | △*1 | -  |
| 9. | column_statistic | string  | カラム統計情報。                      | -  | -    | -  |

- *はすべてのメタデータオブジェクトに含まれるパラメータであることを示す。
- "採番"の項目はadd()メソッド実行時に値を入力しても無視される。
- "add"はaddメソッド実行時に入力が必須の項目。
- *1 column_id, column_name, oridinal_positionからの選択必須。

##### 列統計情報オブジェクト例（JSON形式でのイメージ）

- 例１）すべての項目を設定した場合
  - addメソッド実行時

    ```text
    {
      "name": "PUBLIC.foo.col1.stat", 
      "table_id": 2, 
      "column_id": 32, 
      "column_name": "col1", 
      "ordinal_position": 1, 
      "column_statistic": {...}
    }
    ```

  - getメソッド実行時

    ```text
    {
      "format_version": 1, 
      "generation": 1, 
      "id": 3, 
      "name": "PUBLIC.foo.col1.stat", 
      "table_id": 2, 
      "column_id": 32, 
      "column_name": "col1", 
      "ordinal_position": 1, 
      "column_statistic": {...}
    }
    ```

- 例２）最低限の項目を設定した場合
  - addメソッド実行時

    ```text
    {
      "table_id": 2, 
      "ordinal_position": 1, 
      "column_statistic": {...}
    }
    ```

  - getメソッド実行時

    ```text
    {
      "format_version": 1, 
      "generation": 1, 
      "id": 3, 
      "name": "", 
      "table_id": 2, 
      "column_id": 0, 
      "column_name": "", 
      "ordinal_position": 1, 
      "column_statistic": {...}
    }
    ```

### G. 案３の統計情報オブジェクト

統計情報オブジェクトはテーブルごとに作成され、そのテーブルが持つすべてのカラムのカラム統計情報オブジェクトを持つ。

なお、カラム統計情報のフォーマットは従来仕様から変更がない（フリーフォーマット）。

- 統計情報オブジェクト

  | # | キー名 | データ型 | 説明 | 採番 | add | 備考 |
  |---|---|---|---|---|---|---|
  | 1. | format_version*| int64_t  | オブジェクトのフォーマットバージョン。      | ○ | -    |          |
  | 2. | generation*    | int64_t  | メタデータの世代。                          | ○ | -    | 予約。   |
  | 3. | id*            | int64_t  | 統計情報オブジェクトのOID。                 | ○ | -    |          |
  | 4. | name*          | string   | 統計情報オブジェクトの名前。                | -  | -    | 任意の名前を設定可能。|
  | 5. | table_id       | int64_t  | 統計情報を持つテーブルのOID。               | -  | △*1 |          |
  | 6. | table_name     | string   | 統計情報を持つテーブルの名前。              | -  | △*1 |          |
  | 7. | table_tuples   | float    | テーブルの推定行数。                        | -  | -    |          |
  | 8. | columns        | Node     | 列統計情報オブジェクト群（下記参照）。      | -  | -    |          |

  - *はすべてのメタデータオブジェクトに含まれる基本パラメータであることを示す。
  - "採番"の項目は統合メタデータ管理基盤で自動入力される値。
  - "add"はaddメソッド実行時に入力が必須の項目。

- 列統計情報オブジェクト

  | # | キー名 | データ型 | 説明 | 採番 | add | 備考 |
  |---|---|---|---|---|---|---|
  | 1. | id*              | int64_t | カラム統計情報オブジェクトのOID。 | ○  | -  | -  |
  | 2. | name*            | string  | カラム名。                        | -   | -  | 任意の名前を設定可能。 |
  | 3. | column_id        | int64_t | カラムのOID。                     | -   | -  | -  |
  | 4. | column_name      | string  | カラム名。                        | -   | -  | -  |
  | 5. | ordinalPosition  | int64_t | カラム番号。                      | -   | ○ | -  |
  | 6. | columnStatistic  | string  | カラム統計情報。                  | -   | -  | -  |

  - *はすべてのメタデータオブジェクトに含まれるパラメータであることを示す。
  - "採番"の項目はadd()メソッド実行時に値を入力しても無視される。
  - "add"はaddメソッド実行時に入力が必須の項目。

#### 統計情報オブジェクト例（JSON形式によるイメージ）

JSON形式での記述イメージ。

- 例１）すべての項目を設定した場合

  ```text
  {
    "format_version": 1,
    "generation": 1,
    "id": 2,
    "name": PUBLIC."foo_table.stat",
    "table_id": 2,
    "table_name": "PUBLIC.foo_table",
    "table_tuples": 10000,
    "columns": [
      { "id": 33, 
        "name": "col1.stat", 
        "column_id": 3, 
        "column_name": "col1", 
        "ordinalPosition": 1,
        "columnStatistic": {...}  
      },
      { "id": 34, 
        "name": "col2.stat", 
        "column_id": 4, 
        "column_name": "col2", 
        "ordinalPosition": 2, 
        "columnStatistic": {...}  
      },
      { "id": 35, 
        "name": "col3.stat", 
        "column_id": 5, 
        "column_name": "col3", 
        "ordinalPosition": 3, 
        "columnStatistic": {...}  
      }
    ]
  }
  ```

以上
