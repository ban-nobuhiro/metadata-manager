<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>manager: authentication-manager</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">manager
   &#160;<span id="projectnumber">..</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">authentication-manager </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>【Project-Tsurugi Intern User Only】</p>
<h1>認証管理基盤 ユーザ認証機能 詳細設計</h1>
<p>2021.11.11 NEC</p>
<h2>目次</h2>
<ul>
<li><a href="#認証管理基盤-ユーザ認証機能-詳細設計">認証管理基盤 ユーザ認証機能 詳細設計</a><ul>
<li><a href="#目次">目次</a></li>
<li><a href="#外部設計">外部設計</a><ul>
<li><a href="#ライブラリ">ライブラリ</a></li>
<li><a href="#authenticationクラス">Authenticationクラス</a><ul>
<li><a href="#auth_userメソッド">auth_userメソッド</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#内部設計">内部設計</a><ul>
<li><a href="#ネームスペース一覧">ネームスペース一覧</a></li>
<li><a href="#クラス一覧">クラス一覧</a></li>
<li><a href="#クラス図">クラス図</a></li>
<li><a href="#シーケンス図">シーケンス図</a></li>
<li><a href="#authenticationクラス-1">Authenticationクラス</a><ul>
<li><a href="#auth_userメソッド-1">auth_userメソッド</a></li>
</ul>
</li>
<li><a href="#authenticationproviderクラス">AuthenticationProviderクラス</a><ul>
<li><a href="#auth_userメソッド-2">auth_userメソッド</a></li>
</ul>
</li>
<li><a href="#dbsessionmanagerクラス">DBSessionManagerクラス</a><ul>
<li><a href="#postgresql">PostgreSQL</a></li>
<li><a href="#attempt_connectionメソッド">attempt_connectionメソッド</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#その他">その他</a><ul>
<li><a href="#ライブラリ名">ライブラリ名</a></li>
<li><a href="#ビルド方法">ビルド方法</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2>外部設計</h2>
<h3>ライブラリ</h3>
<blockquote class="doxtable">
<p>認証管理基盤ライブラリ（<code>libmanager-authentication.so</code>） </p>
</blockquote>
<h3>Authenticationクラス</h3>
<div class="fragment"><div class="line">{C++}</div><div class="line">// Header &lt;manager/authentiction/authentication.h&gt;</div><div class="line"></div><div class="line">namespace manager::authentiction {</div><div class="line">  class Authentication {</div><div class="line">    static ErrorCode auth_user(const boost::property_tree::ptree&amp; params);</div><div class="line">    static ErrorCode auth_user(std::string_view conninfo);</div><div class="line">  }</div><div class="line">}</div></div><!-- fragment --><h4>auth_userメソッド</h4>
<ul>
<li><b>概要</b> 入力されたDB接続パラメータが有効であるかを確認する。</li>
<li><b>書式</b></li>
</ul>
<div class="fragment"><div class="line">{C++}</div><div class="line">  static ErrorCode auth_user(const boost::property_tree::ptree&amp; params);</div><div class="line">  static ErrorCode auth_user(std::string_view conninfo);</div></div><!-- fragment --><ul>
<li><b>引数</b><ul>
<li><code>params</code> ptree形式で指定した接続パラメータ。 参考：<a href="https://www.postgresql.jp/document/12/html/libpq-connect.html#LIBPQ-PARAMKEYWORDS">(PostgreSQL) パラメータキーワード</a></li>
<li><code>conninfo</code> DBに依存した接続文字列の形式で指定した接続パラメータ。 参考：<a href="https://www.postgresql.jp/document/12/html/libpq-connect.html#LIBPQ-CONNSTRING">(PostgreSQL) 接続文字列</a></li>
</ul>
</li>
<li><b>戻り値</b><ul>
<li><code>ErrorCode::OK</code> 入力された接続情報が有効である場合。</li>
<li><code>ErrorCode::AUTHENTICATION_FAILURE</code> 入力された接続情報が無効である場合。</li>
<li><code>ErrorCode::CONNECTION_FAILURE</code> データベースへの接続に失敗した場合。</li>
</ul>
</li>
<li><b>使用例</b><ul>
<li><p class="startli">接続情報確認API（パラメータキーワード）</p>
<p class="startli">```C++ boost::property_tree::ptree params; params.put("user", "foo"); params.put("password", "secret"); params.put("host", "localhost"); params.put("port", "5432"); params.put("dbname", "tsurugi_db");</p>
<p class="startli">ErrorCode error = Authentication::auth_user(params); if (error != ErrorCode::OK) { ... } ```</p>
</li>
<li><p class="startli">接続情報確認API（接続文字列）</p>
<p class="startli">```C++ std::string conninfo = "postgresql://foo:secret@localhost:5432/tsurugi_db";</p>
<p class="startli">ErrorCode error = Authentication::auth_user(conninfo); if (error != ErrorCode::OK) { ... } ```</p>
<p class="startli">```C++ std::string conninfo = "user=foo password=secret host=localhost port=5432 dbname=tsurugi_db";</p>
<p class="startli">ErrorCode error = Authentication::auth_user(conninfo); if (error != ErrorCode::OK) { ... } ``` </p><hr/>
</li>
</ul>
</li>
</ul>
<h2>内部設計</h2>
<h3>ネームスペース一覧</h3>
<table class="doxtable">
<tr>
<th>ネームスペース名</th><th>概要  </th></tr>
<tr>
<td><code><a class="el" href="namespacemanager_1_1authentication.html">manager::authentication</a></code></td><td>サービス層ネームスペース </td></tr>
<tr>
<td><code><a class="el" href="namespacemanager_1_1authentication_1_1db.html">manager::authentication::db</a></code></td><td>DAO用ネームスペース </td></tr>
<tr>
<td><code><a class="el" href="namespacemanager_1_1authentication_1_1db_1_1postgresql.html">manager::authentication::db::postgresql</a></code></td><td>PostgreSQL用ネームスペース </td></tr>
</table>
<h3>クラス一覧</h3>
<table class="doxtable">
<tr>
<th>クラス/構造体/列挙体</th><th>ヘッダファイル</th><th>概要</th><th>依存  </th></tr>
<tr>
<td><code><a class="el" href="classmanager_1_1authentication_1_1Authentication.html">manager::authentication::Authentication</a></code></td><td><code><a class="el" href="authentication_8h.html">authentication.h</a></code></td><td>ユーザ認証クラス（API）</td><td>--&mdash; </td></tr>
<tr>
<td><code><a class="el" href="classmanager_1_1authentication_1_1db_1_1AuthenticationProvider.html">manager::authentication::db::AuthenticationProvider</a></code></td><td><code><a class="el" href="authentication__provider_8h.html">provider/authentication_provider.h</a></code></td><td>ユーザ認証プロバイダクラス</td><td>--&mdash; </td></tr>
<tr>
<td><code><a class="el" href="classmanager_1_1authentication_1_1db_1_1postgresql_1_1DBSessionManager.html">manager::authentication::db::postgresql::DBSessionManager</a></code></td><td><code>dao/postgresql/db_session_manager.h</code></td><td>DBセッション管理クラス</td><td>PostgreSQL </td></tr>
</table>
<h3>クラス図</h3>
<div class="image">
<img src="./out/uml/ClassDiagram_overview.png" alt="クラス図"/>
</div>
<h3>シーケンス図</h3>
<div class="image">
<img src="./out/uml/SequenceDiagram_authentication.png" alt="シーケンス図"/>
</div>
<h3>Authenticationクラス</h3>
<div class="fragment"><div class="line">{C++}</div><div class="line">// Header &lt;manager/authentiction/authentication.h&gt;</div><div class="line"></div><div class="line">namespace manager::authentiction {</div><div class="line">  class Authentication {</div><div class="line">    static ErrorCode auth_user(const boost::property_tree::ptree&amp; params);</div><div class="line">    static ErrorCode auth_user(std::string_view conninfo);</div><div class="line">  }</div><div class="line">}</div></div><!-- fragment --><h4>auth_userメソッド</h4>
<ul>
<li><b>概要</b> 入力されたDB接続パラメータが有効であるかを確認する。</li>
<li><b>書式</b></li>
</ul>
<div class="fragment"><div class="line">{C++}</div><div class="line">  static ErrorCode auth_user(const boost::property_tree::ptree&amp; params);</div><div class="line">  static ErrorCode auth_user(std::string_view conninfo);</div></div><!-- fragment --><ul>
<li><b>引数</b><ul>
<li><code>params</code> ptree形式で指定した接続パラメータ。</li>
<li><code>conninfo</code> DBに依存した接続文字列の形式で指定した接続パラメータ。</li>
</ul>
</li>
<li><b>戻り値</b><ul>
<li><code>ErrorCode::OK</code> 入力された接続情報が有効である場合。</li>
<li><code>ErrorCode::AUTHENTICATION_FAILURE</code> 入力された接続情報が無効である場合。</li>
<li><code>ErrorCode::CONNECTION_FAILURE</code> データベースへの接続に失敗した場合。</li>
</ul>
</li>
<li><b>処理詳細</b><ol type="1">
<li><a href="#authenticationproviderクラス">AuthenticationProvider</a>::<a href="#auth_userメソッド-1">auth_user()</a>を実行する。</li>
<li>「1.」の実行結果を戻り値として処理を終了する。</li>
</ol>
</li>
</ul>
<h3>AuthenticationProviderクラス</h3>
<div class="fragment"><div class="line">{C++}</div><div class="line">// Header &lt;manager/authentication/provider/authentication_provider.h&gt;</div><div class="line"></div><div class="line">namespace manager::authentication::db {</div><div class="line">  class AuthenticationProvider {</div><div class="line">    static ErrorCode auth_user(const boost::property_tree::ptree&amp; params);</div><div class="line">    static ErrorCode auth_user(std::string_view conninfo);</div><div class="line">  }</div><div class="line">}</div></div><!-- fragment --><h4>auth_userメソッド</h4>
<ul>
<li><b>概要</b> 入力されたDB接続パラメータが有効であるかを確認する。</li>
<li><b>書式</b></li>
</ul>
<div class="fragment"><div class="line">{C++}</div><div class="line">   static ErrorCode auth_user(const boost::property_tree::ptree&amp; params); </div><div class="line">   static ErrorCode auth_user(std::string_view conninfo);</div></div><!-- fragment --><ul>
<li><b>引数</b><ul>
<li><code>params</code> ptree形式で指定した接続パラメータ。</li>
<li><code>conninfo</code> DBに依存した接続文字列の形式で指定した接続パラメータ。</li>
</ul>
</li>
<li><b>戻り値</b><ul>
<li><code>ErrorCode::OK</code> 入力された接続情報が有効である場合。</li>
<li><code>ErrorCode::AUTHENTICATION_FAILURE</code> 入力された接続情報が無効である場合。</li>
<li><code>ErrorCode::CONNECTION_FAILURE</code> データベースへの接続に失敗した場合。</li>
</ul>
</li>
<li><b>処理詳細</b><ol type="1">
<li>引数の型が「<code>boost::property_tree::ptree</code>」である場合は、<a href="#dbsessionmanagerクラス">DBSessionManager</a>::<a href="#attempt_connectionメソッド">attempt_connection()</a>を実行する。</li>
<li>引数の型が「<code>std::string_view</code>」である場合は、当該引数値を<code>boost::property_tree::ptree</code>型の接続情報パラメータに設定（キー名：<code>connection_strings</code>）し、<a href="#dbsessionmanagerクラス">DBSessionManager</a>::<a href="#attempt_connectionメソッド">attempt_connection()</a>を実行する。</li>
<li>「1.」または「2.」の実行結果を戻り値として処理を終了する。</li>
</ol>
</li>
</ul>
<h3>DBSessionManagerクラス</h3>
<h4>PostgreSQL</h4>
<div class="fragment"><div class="line">{C++}</div><div class="line">// Header &lt;manager/authentication/dao/postgresql/db_session_manager.h&gt;</div><div class="line"></div><div class="line">namespace manager::authentication::db::postgresql {</div><div class="line">  class DBSessionManager {</div><div class="line">    static ErrorCode attempt_connection(const boost::property_tree::ptree&amp; params);</div><div class="line">  }</div><div class="line">}</div></div><!-- fragment --><h4>attempt_connectionメソッド</h4>
<ul>
<li><b>概要</b> 入力されたDB接続パラメータを用いて、DBへの接続を試行した結果を返す。</li>
<li><b>書式</b></li>
</ul>
<div class="fragment"><div class="line">{C++}</div><div class="line">   static ErrorCode attempt_connection(const boost::property_tree::ptree&amp; params);</div></div><!-- fragment --><ul>
<li><b>引数</b><ul>
<li><code>params</code> 接続パラメータ。</li>
</ul>
</li>
<li><b>戻り値</b><ul>
<li><code>ErrorCode::OK</code> 入力された接続情報が有効である場合。</li>
<li><code>ErrorCode::AUTHENTICATION_FAILURE</code> 入力された接続情報が無効である場合。</li>
<li><code>ErrorCode::CONNECTION_FAILURE</code> データベースへの接続に失敗した場合。</li>
</ul>
</li>
<li><p class="startli"><b>処理詳細</b></p><ol type="1">
<li>入力された接続パラメータに接続文字列（キー名：<code>connection_strings</code>）が設定されてる場合は、当該値を接続文字列[^1]として取得する。 指定されていない場合は、接続パラメータに指定されている各情報を接続文字列（<code>keyword = value</code>形式）に変換する。</li>
<li>「1.」で取得／変換した接続文字列を引数に指定し&lt;tt&gt;PQping()関数を実行する。</li>
<li>実行結果（戻り値）が［<code>PQPING_OK</code>］以外の場合は［<code>ErrorCode::CONNECTION_FAILURE</code>］を戻り値として処理を終了し、［<code>PQPING_OK</code>］の場合は処理を継続する。</li>
<li>「1.」で取得／変換した接続文字列を引数に指定し&lt;tt&gt;PQconnectdb()関数を実行する。</li>
<li>実行結果（<code>PQstatus()</code>関数の戻り値）が［<code>CONNECTION_OK</code>］の場合は［<code>ErrorCode::OK</code>］、 それ以外の場合は［<code>ErrorCode::AUTHENTICATION_FAILURE</code>］を戻り値として処理を終了する。</li>
</ol>
<p class="startli">[^1]: 文字列形式（<code>keyword = value ...</code>）やURI形式（RFC3986準拠）など </p><hr/>
</li>
</ul>
<h2>その他</h2>
<h3>ライブラリ名</h3>
<blockquote class="doxtable">
<p>認証管理基盤ライブラリ（<code>libmanager-authentication.so</code>） </p>
</blockquote>
<h3>ビルド方法</h3>
<p>cmakeにて「<code>BUILD_TARGET</code>」オプションを指定する。</p>
<ul>
<li><code>ALL</code> - 統合メタデータ管理基盤および認証管理基盤（デフォルト）</li>
<li><code>AUTH</code> - 認証管理基盤のみ</li>
<li><code>METADATA</code> - 統合メタデータ管理基盤のみ</li>
</ul>
<p>コマンド例：</p>
<div class="fragment"><div class="line">◆認証管理基盤ライブラリのみ</div><div class="line">cmake -DCMAKE_BUILD_TYPE=Debug -DBUILD_TARGET=AUTH -H. -B./build.auth</div><div class="line">cmake --build ./build.auth</div></div><!-- fragment --><div class="fragment"><div class="line">◆統合メタデータ管理基盤、認証管理基盤ライブラリ</div><div class="line">cmake-DCMAKE_BUILD_TYPE=Debug -H. -B./build.all</div><div class="line">cmake --build ./build.all</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
