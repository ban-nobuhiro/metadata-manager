<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>manager: 統計情報管理機能_機能設計書</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">manager
   &#160;<span id="projectnumber">..</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">統計情報管理機能_機能設計書 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>【Project-Tsurugi Internal Use Only】</p>
<h1>metadata-manager 列統計・表統計 管理機能 機能設計</h1>
<p>2021.02.03 NEC</p>
<ul>
<li>metadata-manager<ul>
<li>今回開発するバージョンは、V3.0とします。</li>
</ul>
</li>
</ul>
<h2>目次</h2>
<ul>
<li><a href="#metadata-manager-列統計表統計-管理機能-機能設計">metadata-manager 列統計・表統計 管理機能 機能設計</a><ul>
<li><a href="#目次">目次</a></li>
<li><a href="#用語">用語</a></li>
<li><a href="#列統計表統計-管理機能-概要">列統計・表統計 管理機能 概要</a><ul>
<li><a href="#2021年3月までの開発スコープ">2021年3月までの開発スコープ</a></li>
</ul>
</li>
<li><a href="#メタデータ格納先のデータベース設計">メタデータ格納先のデータベース設計</a><ul>
<li><a href="#概要">概要</a></li>
<li><a href="#メタデータ格納先">メタデータ格納先</a></li>
<li><a href="#メタデータ格納先テーブルのデータベーススキーマ">メタデータ格納先テーブルのデータベース・スキーマ</a><ul>
<li><a href="#理由">理由</a></li>
</ul>
</li>
<li><a href="#メタデータ格納先テーブルの権限">メタデータ格納先テーブルの権限</a></li>
<li><a href="#v30で追加するテーブル">V3.0で追加するテーブル</a><ul>
<li><a href="#v30で追加するテーブル一覧">V3.0で追加するテーブル一覧</a></li>
<li><a href="#列統計テーブル">列統計テーブル</a><ul>
<li><a href="#制約">制約</a></li>
<li><a href="#jsonスキーマ">jsonスキーマ</a></li>
<li><a href="#postgresqlシステムカタログのpg_statisticテーブルの列との相違点">PostgreSQLシステムカタログのpg_statisticテーブルの列との相違点</a></li>
</ul>
</li>
<li><a href="#tableメタデータテーブル">Tableメタデータテーブル</a><ul>
<li><a href="#制約-1">制約</a></li>
<li><a href="#postgresqlシステムカタログのpg_classテーブルとの相違点">PostgreSQLシステムカタログのpg_classテーブルとの相違点</a></li>
</ul>
</li>
<li><a href="#columnメタデータテーブル">Columnメタデータテーブル</a><ul>
<li><a href="#制約-2">制約</a></li>
<li><a href="#postgresqlシステムカタログのpg_attributeテーブルとの相違点">PostgreSQLシステムカタログのpg_attributeテーブルとの相違点</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#tsurugi利用者が実施する環境設定">Tsurugi利用者が実施する環境設定</a><ul>
<li><a href="#メタデータ格納先のテーブル定義設定">メタデータ格納先のテーブル定義設定</a></li>
<li><a href="#メタデータ格納先への接続先設定">メタデータ格納先への接続先設定</a><ul>
<li><a href="#環境変数一覧">環境変数一覧</a></li>
<li><a href="#フォーマット">フォーマット</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#メタデータ管理機能-共通api">メタデータ管理機能 共通API</a><ul>
<li><a href="#初期化処理">初期化処理</a><ul>
<li><a href="#処理概要">処理概要</a></li>
<li><a href="#引数">引数</a></li>
<li><a href="#戻り値">戻り値</a></li>
<li><a href="#条件">条件</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#列統計表統計管理機能-api">列統計・表統計管理機能 API</a><ul>
<li><a href="#列統計表統計-管理機能apiのinputについて">列統計・表統計 管理機能APIのinputについて</a></li>
<li><a href="#1カラムの列統計登録更新inputテーブルidカラム番号">1カラムの列統計登録・更新（input：テーブルID・カラム番号）</a><ul>
<li><a href="#処理概要-1">処理概要</a></li>
<li><a href="#引数-1">引数</a></li>
<li><a href="#戻り値-1">戻り値</a></li>
<li><a href="#条件-1">条件</a></li>
<li><a href="#処理詳細">処理詳細</a></li>
</ul>
</li>
<li><a href="#1テーブルの表統計登録更新inputテーブルid行数">1テーブルの表統計登録・更新（input：テーブルID・行数）</a><ul>
<li><a href="#処理概要-2">処理概要</a></li>
<li><a href="#引数-2">引数</a></li>
<li><a href="#戻り値-2">戻り値</a></li>
<li><a href="#条件-2">条件</a></li>
<li><a href="#処理詳細-1">処理詳細</a></li>
</ul>
</li>
<li><a href="#1テーブルの表統計登録更新inputテーブル名行数outputテーブルid">1テーブルの表統計登録・更新（input：テーブル名・行数、output：テーブルID）</a><ul>
<li><a href="#処理概要-3">処理概要</a></li>
<li><a href="#引数-3">引数</a></li>
<li><a href="#戻り値-3">戻り値</a></li>
<li><a href="#条件-3">条件</a></li>
<li><a href="#処理詳細-2">処理詳細</a></li>
</ul>
</li>
<li><a href="#1テーブルの全列統計参照inputテーブルid">1テーブルの全列統計参照（input：テーブルID）</a><ul>
<li><a href="#処理概要-4">処理概要</a></li>
<li><a href="#引数-4">引数</a></li>
<li><a href="#戻り値-4">戻り値</a></li>
<li><a href="#条件-4">条件</a></li>
<li><a href="#処理詳細-3">処理詳細</a></li>
</ul>
</li>
<li><a href="#1カラムの列統計参照inputテーブルidカラム番号">1カラムの列統計参照（input：テーブルID・カラム番号）</a><ul>
<li><a href="#処理概要-5">処理概要</a></li>
<li><a href="#引数-5">引数</a></li>
<li><a href="#戻り値-5">戻り値</a></li>
<li><a href="#条件-5">条件</a></li>
<li><a href="#処理詳細-4">処理詳細</a></li>
</ul>
</li>
<li><a href="#1テーブルの表統計参照inputテーブルid">1テーブルの表統計参照（input：テーブルID）</a><ul>
<li><a href="#処理概要-6">処理概要</a></li>
<li><a href="#引数-6">引数</a></li>
<li><a href="#戻り値-6">戻り値</a></li>
<li><a href="#条件-6">条件</a></li>
<li><a href="#処理詳細-5">処理詳細</a></li>
</ul>
</li>
<li><a href="#1テーブルの表統計参照inputテーブル名outputテーブルid行数">1テーブルの表統計参照（input：テーブル名、output：テーブルID・行数）</a><ul>
<li><a href="#処理概要-7">処理概要</a></li>
<li><a href="#引数-7">引数</a></li>
<li><a href="#戻り値-7">戻り値</a></li>
<li><a href="#条件-7">条件</a></li>
<li><a href="#処理詳細-6">処理詳細</a></li>
</ul>
</li>
<li><a href="#1テーブルの全列統計削除inputテーブルid">1テーブルの全列統計削除（input：テーブルID）</a><ul>
<li><a href="#処理概要-8">処理概要</a></li>
<li><a href="#引数-8">引数</a></li>
<li><a href="#戻り値-8">戻り値</a></li>
<li><a href="#条件-8">条件</a></li>
<li><a href="#処理詳細-7">処理詳細</a></li>
</ul>
</li>
<li><a href="#1カラムの列統計削除inputテーブルidカラム番号">1カラムの列統計削除（input：テーブルID・カラム番号）</a><ul>
<li><a href="#処理概要-9">処理概要</a></li>
<li><a href="#引数-9">引数</a></li>
<li><a href="#戻り値-9">戻り値</a></li>
<li><a href="#条件-9">条件</a></li>
<li><a href="#処理詳細-8">処理詳細</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#エラーコード一覧">エラーコード一覧</a></li>
<li><a href="#ログ">ログ</a></li>
</ul>
</li>
</ul>
<h2>用語</h2>
<ul>
<li>利用者<ul>
<li>Tsurugiを利用する人</li>
</ul>
</li>
<li>メタデータ格納先<ul>
<li>メタデータが永続的に保存される場所</li>
</ul>
</li>
</ul>
<h2>列統計・表統計 管理機能 概要</h2>
<h3>2021年3月までの開発スコープ</h3>
<ul>
<li>メタデータ管理機能共通API<ul>
<li>初期化処理</li>
</ul>
</li>
<li>列統計・表統計管理機能API<ul>
<li>列統計登録・更新<ul>
<li>1カラムの列統計登録・更新（input：テーブルID・カラム番号）</li>
</ul>
</li>
<li>表統計登録・更新<ul>
<li>1テーブルの表統計登録・更新（input：テーブルID・行数）</li>
<li>1テーブルの表統計登録・更新（input：テーブル名・行数、output：テーブルID）★開発スコープ外：時間があれば開発する。</li>
</ul>
</li>
<li>列統計参照<ul>
<li>1カラムの列統計参照（input：テーブルID・カラム番号）</li>
<li>1テーブルの全列統計参照（input：テーブルID）★開発スコープ外：時間があれば開発する。</li>
</ul>
</li>
<li>表統計参照<ul>
<li>1テーブルの表統計参照（input：テーブルID）</li>
<li>1テーブルの表統計参照（input：テーブル名、output：テーブルID・行数）★開発スコープ外：時間があれば開発する。</li>
</ul>
</li>
<li>列統計削除<ul>
<li>1カラムの列統計削除（input：テーブルID・カラム番号）</li>
<li>1テーブルの全列統計削除（input：テーブルID）★開発スコープ外：時間があれば開発する。</li>
</ul>
</li>
</ul>
</li>
<li>★以外のAPIを作成すれば、最低限、列統計・表統計が管理可能となる。</li>
</ul>
<h2>メタデータ格納先のデータベース設計</h2>
<h3>概要</h3>
<ul>
<li>V2.0では、次のメタデータをjsonファイルにjson形式で格納していた。V3.0では、性能を考慮して、リレーショナルデータベースにテーブル形式で格納する。<ul>
<li>Tableメタデータオブジェクト</li>
<li>Columnメタデータオブジェクト</li>
<li>DataTypesメタデータオブジェクト<ul>
<li>メタデータフォーマットは次を参照</li>
<li><a href="https://github.com/project-tsurugi/manager/blob/master/metadata-manager/docs/table_metadata.md#%E3%83%A1%E3%82%BF%E3%83%87%E3%83%BC%E3%82%BF%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%88">https://github.com/project-tsurugi/manager/blob/master/metadata-manager/docs/table_metadata.md#%E3%83%A1%E3%82%BF%E3%83%87%E3%83%BC%E3%82%BF%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%88</a></li>
</ul>
</li>
</ul>
</li>
<li>Tableメタデータ・Columnメタデータ<ul>
<li>V3.0では、V2.0の概念スキーマをそのまま流用し、Tableメタデータ・Columnメタデータ・表統計を、データベースに格納する。<ul>
<li>理由<ul>
<li>列統計・表統計管理機能APIで、Columnメタデータテーブルのカラム番号との参照制約を設定するため。</li>
<li>Tableメタデータテーブルに表統計を追加するため。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>列統計<ul>
<li>V3.0で概念スキーマを新規に設計し、列統計をデータベースに格納する。</li>
</ul>
</li>
</ul>
<h3>メタデータ格納先</h3>
<ul>
<li>メタデータ格納先<ul>
<li>PostgreSQL</li>
</ul>
</li>
<li>metadata-managerがメタデータ格納先に問い合わせするAPI<ul>
<li><a href="https://www.postgresql.jp/document/12/html/libpq.html">libpq</a></li>
</ul>
</li>
</ul>
<h3>メタデータ格納先テーブルのデータベース・スキーマ</h3>
<ul>
<li>メタデータが格納されるテーブルのデータベースは、デフォルトでは次の表の通りとする。<ul>
<li>OSの環境変数で、データベース名・ホスト名・ポート・ユーザー名・パスワードを変更可能とする。<ul>
<li>詳細は<a href="#Tsurugi利用者が実施する環境設定">Tsurugi利用者が実施する環境設定</a>を参照</li>
</ul>
</li>
</ul>
</li>
</ul>
<table class="doxtable">
<tr>
<th>項目 </th><th>デフォルト値  </th></tr>
<tr>
<td>データベース名 </td><td>tsurugi </td></tr>
<tr>
<td>ホスト名 </td><td>localhost </td></tr>
<tr>
<td>ポート </td><td>5432 </td></tr>
<tr>
<td>ユーザー名 </td><td>カレントユーザー[^2] </td></tr>
<tr>
<td>パスワード </td><td>&lt;カレントユーザー[^2]のホームディレクトリの絶対パス&gt;/.pgpass </td></tr>
<tr>
<td>LC_COLLATE </td><td>'C' </td></tr>
<tr>
<td>LC_CTYPE </td><td>'C' </td></tr>
<tr>
<td>ENCODING </td><td>'UTF8' </td></tr>
<tr>
<td>設定をコピーするtemplateデータベース<a href="https://www.postgresql.jp/document/12/html/manage-ag-templatedbs.html">^1</a> </td><td>template0 </td></tr>
</table>
<ul>
<li>メタデータが格納されるテーブルのスキーマは次の通りとする。<ul>
<li>スキーマ名<ul>
<li>tsurugi_catalog</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>理由</h4>
<ul>
<li>データベース名をtsurugiにした理由<ul>
<li>データベースtemplate0<ul>
<li>PostgreSQLの仕様として、template0にオブジェクトを作成できない仕様となっている。</li>
</ul>
</li>
<li>データベースtemplate1<ul>
<li>template1にオブジェクトを作成してから、template1をコピーして他のデータベースを作成する用途がある。そのため、オブジェクトを作成すると、ユーザーの迷惑となる。</li>
</ul>
</li>
</ul>
</li>
<li>スキーマ名がpg_catalogでない理由<ul>
<li>PostgreSQLでは、pg_catalog.*のテーブルを定義することは禁止されているため。<ul>
<li><p class="startli">pg_catalog.tsurugi_classのテーブルを定義したときのエラーメッセージ</p>
<p class="startli">```bash ERROR: permission denied to create "pg_catalog.tsurugi_class" DETAIL: System catalog modifications are currently disallowed. ```</p>
</li>
<li><p class="startli">postgresql-12.3/src/backend/catalog/heap.c</p>
<p class="startli">```c /*</p><ul>
<li>Don't allow creating relations in pg_catalog directly, even though it</li>
<li>is allowed to move user defined relations there. Semantics with search</li>
<li>paths including pg_catalog are too confusing for now.</li>
<li></li>
<li>But allow creating indexes on relations in pg_catalog even if</li>
<li>allow_system_table_mods = off, upper layers already guarantee it's on a</li>
<li>user defined relation, not a system one. */ ```</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3>メタデータ格納先テーブルの権限</h3>
<ul>
<li>V3.0で追加する全テーブルに対して、Superuserのみにテーブル操作に関するすべての権限を付与する。<ul>
<li>テーブル操作すべての権限<ul>
<li>INSERT可能(append)</li>
<li>SELECT可能(read)</li>
<li>UPDATE可能(write)</li>
<li>DELETE可能(delete)</li>
<li>TRUNCATE</li>
<li>REFERENCES</li>
<li>TRIGGER</li>
</ul>
</li>
<li>Superuser以外のユーザーは、テーブル操作すべての権限を持たない。</li>
<li>SQL<ul>
<li><p class="startli">Superuserのみにテーブル操作すべての権限を付与するとき、Superuserで次のコマンドを実行する。</p>
<p class="startli">```sql GRANT ALL ON ALL TABLES IN SCHEMA tsurugi_catalog To current_user; ```</p>
</li>
</ul>
</li>
</ul>
</li>
<li>理由<ul>
<li>PostgreSQLと同等の仕様とするため。<ul>
<li><p class="startli">postgresがSuperuserの場合</p>
<p class="startli">```sql postgres=#  postgres List of roles Role name | Attributes | Member of --------&mdash;+---------------------------------------------------------&mdash;+--------&mdash; postgres | Superuser, Create role, Create DB, Replication, Bypass RLS | {}</p>
<p class="startli">postgres=# SELECT relname, relacl FROM pg_class c JOIN pg_namespace ns ON (ns.oid = c.relnamespace) WHERE relname = 'pg_attribute' or relname = 'pg_class' or relname = 'pg_statistic'; relname | relacl -----------&mdash;+-----------------------------------&mdash; pg_statistic | {postgres=arwdDxt/postgres} pg_attribute | {postgres=arwdDxt/postgres,=r/postgres} pg_class | {postgres=arwdDxt/postgres,=r/postgres} (3 rows) ```</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3>V3.0で追加するテーブル</h3>
<h4>V3.0で追加するテーブル一覧</h4>
<ul>
<li>列統計テーブル<ul>
<li>テーブル名：tsurugi_statistic</li>
</ul>
</li>
<li>Tableメタデータテーブル<ul>
<li>テーブル名：tsurugi_class</li>
</ul>
</li>
<li>Columnメタデータテーブル<ul>
<li>テーブル名：tsurugi_attribute</li>
</ul>
</li>
</ul>
<h4>列統計テーブル</h4>
<ul>
<li>テーブル名<ul>
<li><b>tsurugi_statistic</b></li>
</ul>
</li>
</ul>
<table class="doxtable">
<tr>
<th>名前 </th><th>型 </th><th>説明 </th><th>NOT NULL  </th></tr>
<tr>
<td><b>tableId</b> </td><td><b>bigint</b> </td><td><b>テーブルID</b> </td><td>NOT NULL </td></tr>
<tr>
<td><b>ordinalPosition</b> </td><td><b>bigint</b> </td><td><b>カラム番号(1 origin)</b> </td><td>NOT NULL </td></tr>
<tr>
<td><b>columnStatistic</b> </td><td><b>json<br />
※ただし、jsonスキーマは、列統計管理機能APIを利用するコンポーネントが決定する。<br />
metadata-managerはjsonスキーマのバリデーションは行わない。</b> </td><td><b>列統計</b> </td><td></td></tr>
</table>
<ul>
<li>カラムIDでなくカラム番号(1 origin)にした理由<ul>
<li>カラムIDやカラム名を知らなくても、カラム番号で列統計をCRUDできる。</li>
<li>カラム番号(1 origin)の1番からソートして順番に表示することができる。<ul>
<li>カラムIDだと、カラムの位置が分かりにくい。</li>
</ul>
</li>
<li>他のDBMSもカラム番号(1 origin)を使っている。<ul>
<li>PostgreSQLの列統計<ul>
<li>カラム番号(1 origin)を使っている。</li>
<li><a href="https://www.postgresql.jp/document/12/html/catalog-pg-statistic.html">https://www.postgresql.jp/document/12/html/catalog-pg-statistic.html</a></li>
</ul>
</li>
<li>oracleの列統計<ul>
<li>カラム番号(1 origin)を使っている。</li>
<li><a href="https://docs.oracle.com/cd/E16338_01/server.112/b56311/statviews_2103.htm">https://docs.oracle.com/cd/E16338_01/server.112/b56311/statviews_2103.htm</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5>制約</h5>
<ul>
<li>indexを張ることで検索速度を速くする、また、行データに一意性を持たせ、行データを特定するため、次の制約を追加する。<ul>
<li>primary key制約<ul>
<li>(tableId, ordinalPosition)の複合主キー<ul>
<li>理由<ul>
<li>PostgreSQLでは、(テーブルID, カラム番号, 継承関係の子の列を含むか否か)の複合UNIQUE制約</li>
<li>しかし、本テーブルの場合、継承関係の子の列を含むか否かは、V3.0では継承テーブルがサポートされないため、複合主キーに含めない。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>次の参照制約を追加する。<ul>
<li>(tableId, ordinalPosition)の複合参照制約<ul>
<li>被参照テーブル<ul>
<li>Columnメタデータテーブル tsurugi_attribute</li>
</ul>
</li>
<li>被参照列<ul>
<li>TableメタデータのテーブルID id</li>
<li>Columnメタデータテーブルのカラム番号 ordinalPosition</li>
</ul>
</li>
<li>MATCH FULL</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5>jsonスキーマ</h5>
<ul>
<li>jsonスキーマは、列統計管理機能APIを利用するコンポーネントが決定する。</li>
<li>推奨するkey/value<ul>
<li>データ型<ul>
<li>データ型のkeyを格納することを推奨する。</li>
<li><p class="startli">例</p>
<p class="startli">```json { "data-type":"string" } ```</p>
</li>
<li>データ型のkeyの格納を推奨する理由<ul>
<li>列統計の値の型は、metadata-managerのデータ型管理機能API・Columnメタデータ管理機能APIを利用して取得する必要がある。</li>
<li>データ型のkeyを挿入しないより挿入したほうが、列統計・表統計管理機能APIのみを利用するだけでよいため、実行速度が速くなる。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5>PostgreSQLシステムカタログのpg_statisticテーブルの列との相違点</h5>
<ul>
<li>pg_statisticテーブルの列統計の複数カラムを、1つのjson型カラムに集約<ul>
<li>理由<ul>
<li>metadata-managerのAPIを利用するコンポーネントが、Tsurugi独自の列統計を格納できるようにするため。</li>
<li>metadata-managerのAPIを利用するコンポーネントが、データ構造を自由に決められるため。<ul>
<li>Tsurugi独自のjsonスキーマでもよい。</li>
<li>PostgreSQLと同様に、スロット形式のjsonスキーマで格納してもよい。</li>
<li>MySQLと同様のjson形式で格納してもよい。<ul>
<li>26.11 The INFORMATION_SCHEMA COLUMN_STATISTICS Table<ul>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/information-schema-column-statistics-table.html">https://dev.mysql.com/doc/refman/8.0/en/information-schema-column-statistics-table.html</a></li>
</ul>
</li>
<li>jsonスキーマの例<ul>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/optimizer-statistics.html">https://dev.mysql.com/doc/refman/8.0/en/optimizer-statistics.html</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>参照制約を追加<ul>
<li>列統計テーブルの（テーブルID、カラム番号）に、Columnメタデータテーブルの（テーブルID、カラム番号）への参照制約を追加<ul>
<li>（テーブルID、カラム番号）との参照関係を示して、カラムIDと間違えないようにするため。</li>
</ul>
</li>
</ul>
</li>
<li>型<ul>
<li>PostgreSQLの型oid、staattnumの型int2それぞれを、bigintに変更<ul>
<li>理由<ul>
<li>metadata-manager V2.0で、テーブルID・カラム番号の型が、uint64_tで定義されているため。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>Tableメタデータテーブル</h4>
<ul>
<li>テーブル名<ul>
<li><b>tsurugi_class</b><ul>
<li>V2.0と概念スキーマは同じ。</li>
</ul>
</li>
</ul>
</li>
</ul>
<table class="doxtable">
<tr>
<th>名前 </th><th>型 </th><th>説明 </th><th>REFERENCES </th><th>NOT NULL  </th></tr>
<tr>
<td><b>id</b> </td><td><b>bigserial</b> </td><td><b>テーブルID</b> </td><td></td><td>NOT NULL </td></tr>
<tr>
<td><b>name</b> </td><td><b>text</b> </td><td><b>テーブル名</b> </td><td></td><td>NOT NULL </td></tr>
<tr>
<td><b>namespace</b> </td><td><b>text</b> </td><td><b>名前空間（テーブル名を除く）</b> </td><td></td><td></td></tr>
<tr>
<td><b>primaryKey</b> </td><td><b>json<br />
※値はarray[bigint]が挿入されるが、<br />
metadata-managerはjsonスキーマのバリデーションは行わない。</b> </td><td><b>primaryKeyカラムのカラム番号"ordinalPosition"</b> </td><td></td><td></td></tr>
<tr>
<td>reltuples </td><td>real </td><td>行数 </td><td></td><td></td></tr>
</table>
<h5>制約</h5>
<ul>
<li>indexを張ることで検索速度を速くする、また、行データに一意性を持たせ、行データを特定するため、次の制約を追加する。<ul>
<li>primary key制約<ul>
<li>id</li>
</ul>
</li>
<li>PostgreSQLではnameとnamespaceがUNIQUE制約であるが、tsurugiでは両方UNIQUE制約は設定しない。<ul>
<li>理由<ul>
<li>前提として、同名のテーブル名は、テーブルメタデータテーブルおよびOLTPに登録できない仕様となっているが、frontendでogawayama-serverから返却されたエラーコードを表示するため。</li>
<li>V3.0でnamespaceはサポートされないため、namespaceはUNIQUE制約に含めない。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5>PostgreSQLシステムカタログのpg_classテーブルとの相違点</h5>
<ul>
<li>太字がpg_classとの変更点</li>
<li>列の変更<ul>
<li>表統計<ul>
<li>reltuplesのNOT NULL制約を削除。<ul>
<li>理由<ul>
<li>metadata-managerのAPIを利用するTsurugiのコンポーネント（ogawayamaなど）が格納する表統計が決まっていないため。</li>
</ul>
</li>
</ul>
</li>
<li>pg_classテーブルのreltuples以外の表統計が存在しない。<ul>
<li>理由<ul>
<li>実行エンジンにページ数の概念がない可能性があるため。</li>
<li>プランナが計算する選択度の計算に、行数以外の表統計は不要であるため。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>primaryKey列を追加<ul>
<li>理由<ul>
<li>metadata-manager V2.0と同様に、metadata-managerがptree型のオブジェクトで受け取ったprimaryKeyを、メタデータ格納先にjson型でそのまま格納するため。</li>
</ul>
</li>
</ul>
</li>
<li>primaryKey列にNOT NULL制約が設定されていない。<ul>
<li>理由<ul>
<li>PostgreSQLでは、主キー制約がないテーブルを定義できるため。<ul>
<li>ただし、Tsurugiでは、主キーを必ず1つ以上設定する必要がある。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>Columnメタデータテーブル</h4>
<ul>
<li>テーブル名<ul>
<li><b>tsurugi_attribute</b><ul>
<li>V2.0と概念スキーマは同じ。</li>
</ul>
</li>
</ul>
</li>
</ul>
<table class="doxtable">
<tr>
<th>名前 </th><th>型 </th><th>説明 </th><th>REFERENCES </th><th>NOT NULL  </th></tr>
<tr>
<td><b>id</b> </td><td><b>bigserial</b> </td><td><b>カラムID</b> </td><td></td><td>NOT NULL </td></tr>
<tr>
<td><b>tableId</b> </td><td><b>bigint</b> </td><td><b>テーブルID</b> </td><td><b>TableメタデータテーブルのテーブルID</b> </td><td>NOT NULL </td></tr>
<tr>
<td><b>name</b> </td><td><b>text</b> </td><td><b>カラム名</b> </td><td></td><td>NOT NULL </td></tr>
<tr>
<td><b>ordinalPosition</b> </td><td><b>bigint</b> </td><td><b>カラム番号(1 origin)</b> </td><td></td><td>NOT NULL </td></tr>
<tr>
<td><b>dataTypeId</b> </td><td><b>bigint</b> </td><td><b>カラムのデータ型のID<br />
データタイプメタデータを参照</b> </td><td></td><td>NOT NULL </td></tr>
<tr>
<td><b>dataLength</b> </td><td><b>json<br />
※値は、array[bigint]が挿入されるが、<br />
metadata-managerはjsonスキーマのバリデーションは行わない。</b> </td><td><b>データ長(配列長)<br />
varchar(20)など ※V1では未使用<br />
NUMERIC(precision,scale)を考慮してarray[bigint] にしている。<br />
array[bigint] か number かは継続して検討。</b> </td><td></td><td></td></tr>
<tr>
<td><b>varying</b> </td><td><b>bool</b> </td><td><b>文字列長が可変か否か</b> </td><td></td><td></td></tr>
<tr>
<td><b>nullable</b> </td><td><b>bool</b> </td><td><b>NOT NULL制約の有無</b> </td><td></td><td>NOT NULL </td></tr>
<tr>
<td><b>defaultExpr</b> </td><td><b>text</b> </td><td><b>デフォルト式</b> </td><td></td><td></td></tr>
<tr>
<td><b>direction</b> </td><td><b>bigint</b> </td><td><b>方向（0: DEFAULT, 1: ASCENDANT, 2: DESCENDANT）</b> </td><td></td><td></td></tr>
</table>
<h5>制約</h5>
<ul>
<li>indexを張ることで検索速度を速くする、また、行データに一意性を持たせ、行データを特定するため、次の制約を追加する。<ul>
<li>primary key制約<ul>
<li>(tableId, id)の複合主キー</li>
</ul>
</li>
<li>UNIQUE制約<ul>
<li>(tableId, name)の複合UNIQUE制約<ul>
<li>PostgreSQLと同じ</li>
</ul>
</li>
<li>(tableId, ordinalPosition)の複合UNIQUE制約<ul>
<li>PostgreSQLと同じ</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5>PostgreSQLシステムカタログのpg_attributeテーブルとの相違点</h5>
<ul>
<li>太字がpg_attributeとの変更点</li>
<li>すべての列を変更した<ul>
<li>理由<ul>
<li>indexを張ることで検索速度を速くするため。</li>
<li>V2.0のメタデータの概念スキーマと同じ概念スキーマとするため。<ul>
<li>metadata-manager V2.0と同様に、metadata-managerがptree型のオブジェクトで受け取ったColumnメタデータを、メタデータ格納先に永続化するため。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2>Tsurugi利用者が実施する環境設定</h2>
<h3>メタデータ格納先のテーブル定義設定</h3>
<ul>
<li>Tsurugiの利用者は、Tsurugiのインストール時に、SQLファイルを実行する。<ul>
<li>SQLファイルの内容<ol type="1">
<li><p class="startli">次のコマンドを実行して、データベースを作成する。</p>
<p class="startli">```sql CREATE DATABASE tsurugi LC_COLLATE 'C' LC_CTYPE 'C' ENCODING 'UTF8' template=template0; ```</p>
</li>
<li>CREATE SCHEMA tsurugi_catalog;</li>
<li><a href="#メタデータ格納先のデータベース設計">メタデータ格納先のデータベース設計</a>の全テーブルのテーブル定義を行う。<ul>
<li>制約の定義も行う。</li>
</ul>
</li>
<li>スキーマtsurugi_catalogの全テーブルに対して、Superuserのみにテーブル操作に関するすべての権限を付与する。</li>
</ol>
</li>
</ul>
</li>
</ul>
<h3>メタデータ格納先への接続先設定</h3>
<ul>
<li>metadata-managerは、メタデータ格納先に関するデフォルトの接続先情報（Connection Strings）を利用して、メタデータ格納先に接続する。<ul>
<li>Tsurugiの利用者は、メタデータ格納先の接続先を変更したい場合、OSの環境変数でConnection Stringsを設定する。</li>
</ul>
</li>
</ul>
<h4>環境変数一覧</h4>
<table class="doxtable">
<tr>
<th>No. </th><th>項目名 </th><th>環境変数名 </th><th>デフォルト値 </th><th>値の範囲  </th></tr>
<tr>
<td>1 </td><td>Connection Strings </td><td>TSURUGI_CONNECTION_STRING </td><td>"dbname = tsurugi" </td><td>メタデータ格納先の接続先情報 </td></tr>
</table>
<h4>フォーマット</h4>
<ul>
<li>Connection Strings<ul>
<li>libpqで利用できるConnection Stringsのフォーマット[^3]のうち、「Keyword/Value Connection Strings」「Connection URIs」のどちらかのフォーマットとする。<ul>
<li>[^3]:「libpq - 33.1.1. Connection Strings」https://www.postgresql.org/docs/12/libpq-connect.html::LIBPQ-CONNSTRING ↩</li>
<li>ただし、次の制限事項がある。<ul>
<li>データベース名・ホスト名・ポート・ユーザー名・パスワードのみ指定可能。それ以外のパラメーターは指定不可。</li>
<li>データベース名・ホスト名・ポート・ユーザー名・パスワードそれぞれ1つずつのみ指定可能。<ul>
<li>1つの接続先のみ指定可能。複数の接続先は指定不可。</li>
</ul>
</li>
</ul>
</li>
<li>制限事項の理由<ul>
<li>制限事項に記載のConnection Strings以外をサポートするユースケースがないため。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>例1</li>
</ul>
<div class="fragment"><div class="line">export TSURUGI_CONNECTION_STRING = &quot;host=localhost port=5432 dbname=mydb&quot; </div></div><!-- fragment --><ul>
<li>例2</li>
</ul>
<div class="fragment"><div class="line">export TSURUGI_CONNECTION_STRING = &quot;postgresql://localhost:5433/mydb&quot; </div></div><!-- fragment --><h2>メタデータ管理機能 共通API</h2>
<h3>初期化処理</h3>
<h4>処理概要</h4>
<ul>
<li>メタデータ管理機能API（初期化処理以外）の関数を呼ぶ前に、本APIを呼ぶ。</li>
<li>初期化処理を呼ばなければ、他のメタデータ管理機能API内で、初期化処理が呼ばれる。</li>
<li>初期化処理は下記3つの処理を実施する。下記3つすべての処理が成功した場合、metadata-managerは、メタデータ格納先とメタデータの受け渡しが可能となる。<ol type="1">
<li>metadata-managerは、メタデータ格納先とのコネクションが確立済みでない場合、メタデータ格納先とのコネクションを確立する。<ul>
<li>コネクションの確立に成功した場合、確立したコネクション1つを保持する。</li>
</ul>
</li>
<li>metadata-managerは、サーチパスがセキュアになるように設定する。<ul>
<li>悪意のあるユーザーに制御を奪われないようにするため。</li>
</ul>
</li>
<li>metadata-managerは、メタデータ格納先に対してプリペアードステートメントを送り、プリペアードステートメントの前処理の実行を指示する。</li>
</ol>
</li>
</ul>
<h4>引数</h4>
<ul>
<li>なし</li>
</ul>
<h4>戻り値</h4>
<table class="doxtable">
<tr>
<th>プロパティ名（論理名） </th><th>型 </th><th>値の範囲  </th></tr>
<tr>
<td>エラーコード </td><td>ErrorCode </td><td>ErrorCode::OK：正常<br />
ErrorCode::DATABASE_ACCESS_FAILURE：メタデータ格納先に障害が発生した。 </td></tr>
</table>
<h4>条件</h4>
<ul>
<li>事前条件<ul>
<li>なし</li>
</ul>
</li>
<li>事後条件<ul>
<li>戻り値として、ErrorCodeを返す。<ul>
<li>ErrorCode::OKが返ってきた場合<ul>
<li>列統計・表統計管理機能 APIを利用可能となり、メタデータ格納先とのメタデータの受け渡しが可能となる。</li>
</ul>
</li>
<li>ErrorCode::DATABASE_ACCESS_FAILUREが返ってきた場合<ul>
<li>metadata-managerは、メタデータ格納先とメタデータの受け渡しができない。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2>列統計・表統計管理機能 API</h2>
<h3>列統計・表統計 管理機能APIのinputについて</h3>
<ul>
<li>列統計・表統計管理機能APIのinputをテーブルIDとした理由<ol type="1">
<li>ogawayamaは、テーブルIDをキャッシュに持っているため。<ul>
<li>テーブル名からテーブルIDを取得するために、メタデータ格納先にアクセスする必要がない。</li>
</ul>
</li>
<li>inputをテーブルIDで統一するため。</li>
</ol>
</li>
<li>列統計管理機能APIのinputを「カラム番号」とした理由<ul>
<li>カラムIDやカラム名ではなく、カラム番号をinputとすることで、Columnメタデータテーブルにアクセスする必要がなくなるため。<ul>
<li>列統計管理機能API利用の流れ<ol type="1">
<li>metadata-managerのAPIを利用するTsurugiのコンポーネントは、次の処理を行うときに、各テーブルの「カラム数またはカラム番号のリスト」をメモリに保持する。<ul>
<li>Tsurugiの利用者がDDL(CREATE TABLE,ALTER TABLE)を発行したとき</li>
<li>自コンポーネントが起動するとき<ul>
<li>自コンポーネントが起動するときは、Columnメタデータテーブルから「カラム数またはカラム番号のリスト」を取得する。</li>
</ul>
</li>
</ul>
</li>
<li>metadata-managerのAPIを利用するTsurugiのコンポーネント（ogawayamaなど）は、列統計管理機能APIを利用する。</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
<li>表統計管理機能APIで、inputがテーブル名のAPIを用意した理由<ul>
<li>列統計・表統計の登録・更新フロー<ol type="1">
<li>表統計（行数）の登録・更新を行い、テーブルIDを取得する。<ul>
<li>アクセス先：Tableメタデータテーブル【tsurugi_class】</li>
</ul>
</li>
<li>テーブルIDをinputとし、全カラムの列統計を登録・更新する。<ul>
<li>アクセス先：列統計テーブル【tsurugi_statistic】</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<p>列統計・表統計の参照フロー</p><ol type="1">
<li>表統計（行数）の参照を行い、テーブルID・行数を取得<ul>
<li>アクセス先：Tableメタデータテーブル【tsurugi_class】</li>
</ul>
</li>
<li>テーブルIDをinputとし、各カラムの列統計を参照する。<ul>
<li>アクセス先：列統計テーブル【tsurugi_statistic】</li>
</ul>
</li>
</ol>
<h3>1カラムの列統計登録・更新（input：テーブルID・カラム番号）</h3>
<h4>処理概要</h4>
<ul>
<li>metadata-managerは、メタデータ格納先に**1カラム単位の列統計**を登録・更新する。<ul>
<li>1カラム単位の列統計の全項目を更新する。一部の列統計の部分更新は不可とする。<ul>
<li>たとえば、NULL率のみの更新はできず、NULL率以外の列統計も一緒に更新しなければならない。</li>
</ul>
</li>
</ul>
</li>
<li>登録・更新の単位を、1カラム単位の列統計としている理由<ul>
<li>PostgreSQLの次のソースコードを参考にしている。<ul>
<li>postgresql-12.3/src/backend/commands/analyze.c<ul>
<li><p class="startli">PostgreSQLの列統計登録・更新APIは、引数としてテーブルID・カラム数・全カラムの列統計の値が指定される。</p>
<p class="startli">```C /*</p><ul>
<li>update_attstats() &ndash; update attribute statistics for one relation (略) */ static void update_attstats(Oid relid, bool inh, int natts, VacAttrStats **vacattrstats) ```</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>引数</h4>
<table class="doxtable">
<tr>
<th>プロパティ名<br />
（論理名） </th><th>プロパティ名<br />
（物理名） </th><th>型 </th><th>型の備考 </th><th>IN/OUT </th><th>省略指定 </th><th>値の範囲  </th></tr>
<tr>
<td>テーブルID </td><td>table_id </td><td>int64_t </td><td></td><td>IN </td><td>省略不可 </td><td>1以上 </td></tr>
<tr>
<td>カラム番号 </td><td>ordinal_position </td><td>int64_t </td><td></td><td>IN </td><td>省略不可 </td><td>1以上 </td></tr>
<tr>
<td>1カラム単位の列統計 </td><td>column_statistic </td><td>boost::property_tree::ptree&amp; </td><td><b>参照渡し</b> </td><td>IN </td><td>省略不可 </td><td>型の範囲 </td></tr>
</table>
<h4>戻り値</h4>
<table class="doxtable">
<tr>
<th>プロパティ名（論理名） </th><th>型 </th><th>値の範囲  </th></tr>
<tr>
<td>エラーコード </td><td>ErrorCode </td><td>ErrorCode::OK：正常<br />
ErrorCode::INVALID_PARAMETER：引数に、テーブルメタデータテーブルに存在しないテーブルID・カラム番号が入力された。<br />
ErrorCode::DATABASE_ACCESS_FAILURE：メタデータ格納先に障害が発生した。 </td></tr>
</table>
<h4>条件</h4>
<ul>
<li>事前条件<ul>
<li>引数に、テーブルID、カラム番号、テーブルID・カラム番号に紐づく1カラム単位の列統計が指定されている。</li>
</ul>
</li>
<li>事後条件<ul>
<li>戻り値として、ErrorCodeを返す。</li>
</ul>
</li>
</ul>
<h4>処理詳細</h4>
<ol type="1">
<li>metadata-managerは、事前条件に基づき、引数の入力規則チェックを実施する。<ul>
<li>テーブルID &lt;= 0 または カラム番号 &lt;= 0 の場合<ul>
<li>metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。</li>
</ul>
</li>
</ul>
</li>
<li>メタデータ格納先は、Transactionを開始する。</li>
<li>metadata-managerは、メタデータ格納先の列統計テーブル【tsurugi_statistic】から、テーブルID、カラム番号が、引数テーブルID、カラム番号それぞれに一致するレコードを取得する。<ul>
<li>一致するレコードが存在する場合<ul>
<li>メタデータ格納先は、引数column_statisticを基に、テーブルID・カラム番号に一致するレコードの各列に対して、値を上書きする。</li>
</ul>
</li>
<li>一致するレコードが存在しない場合<ul>
<li>メタデータ格納先は、引数column_statisticを基に、列統計テーブル【tsurugi_statistic】に対して、新たなレコードを登録する。</li>
</ul>
</li>
</ul>
</li>
<li>3.でレコードの登録・更新に成功した場合<ol type="a">
<li>メタデータ格納先は、commit処理を行い、Transactionを終了する。</li>
<li>metadata-managerは、戻り値にErrorCode::OKを設定し、処理を終了する。</li>
</ol>
</li>
<li>3.でレコードの登録・更新に失敗した場合<ol type="a">
<li>メタデータ格納先は、rollback処理を行い、Transactionを終了する。</li>
<li>metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。</li>
</ol>
</li>
</ol>
<h3>1テーブルの表統計登録・更新（input：テーブルID・行数）</h3>
<h4>処理概要</h4>
<ul>
<li>metadata-managerは、メタデータ格納先に対して、**1テーブル単位の表統計**を登録・更新する。</li>
<li>登録・更新の単位を、1テーブル単位の表統計としている理由<ul>
<li>PostgreSQLの次のソースコードを参考にした。<ul>
<li>postgresql-12.3/src/backend/commands/vacuum.c<ul>
<li><p class="startli">PostgreSQLの場合、表統計登録・更新APIは、引数としてテーブルIDを含むRelation構造体・行数num_tuplesが指定される。</p>
<p class="startli">```C /*</p><ul>
<li>vac_update_relstats() &ndash; update statistics for one relation （略） */ void vac_update_relstats(Relation relation, BlockNumber num_pages, double num_tuples, BlockNumber num_all_visible_pages, bool hasindex, TransactionId frozenxid, MultiXactId minmulti, bool in_outer_xact) { Oid relid = RelationGetRelid(relation); ```</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>引数</h4>
<table class="doxtable">
<tr>
<th>プロパティ名<br />
（論理名） </th><th>プロパティ名<br />
（物理名） </th><th>型 </th><th>型の備考 </th><th>IN/OUT </th><th>省略指定 </th><th>値の範囲  </th></tr>
<tr>
<td>テーブルID </td><td>table_id </td><td>int64_t </td><td></td><td>IN </td><td>省略不可 </td><td>1以上 </td></tr>
<tr>
<td>行数 </td><td>reltuples </td><td>float </td><td></td><td>IN </td><td>省略不可 </td><td>型の範囲 </td></tr>
</table>
<h4>戻り値</h4>
<table class="doxtable">
<tr>
<th>プロパティ名（論理名） </th><th>型 </th><th>値の範囲  </th></tr>
<tr>
<td>エラーコード </td><td>ErrorCode </td><td>ErrorCode::OK：正常<br />
ErrorCode::INVALID_PARAMETER：引数に、存在しないテーブルIDが入力された。<br />
ErrorCode::DATABASE_ACCESS_FAILURE：メタデータ格納先に障害が発生した。 </td></tr>
</table>
<h4>条件</h4>
<ul>
<li>事前条件<ul>
<li>引数に、テーブルID、行数が指定されている。</li>
</ul>
</li>
<li>事後条件<ul>
<li>戻り値として、ErrorCodeを返す。</li>
</ul>
</li>
</ul>
<h4>処理詳細</h4>
<ol type="1">
<li>metadata-managerは、事前条件に基づき、引数の入力規則チェックを実施する。<ul>
<li>テーブルID &lt;= 0の場合<ul>
<li>metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。</li>
</ul>
</li>
</ul>
</li>
<li>メタデータ格納先はTransactionを開始する。</li>
<li>metadata-managerは、引数table_id、reltuplesを基に、Tableメタデータテーブル【tsurugi_class】の列reltuplesを更新する。</li>
<li>3.でレコードの登録・更新に成功した場合<ol type="a">
<li>メタデータ格納先は、commit処理を行い、Transactionを終了する。</li>
<li>metadata-managerは、戻り値にErrorCode::OKを設定し、処理を終了する。</li>
</ol>
</li>
<li>3.でレコードの登録・更新に失敗した場合<ol type="a">
<li>メタデータ格納先は、rollback処理を行い、Transactionを終了する。</li>
<li>metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。</li>
</ol>
</li>
</ol>
<h3>1テーブルの表統計登録・更新（input：テーブル名・行数、output：テーブルID）</h3>
<h4>処理概要</h4>
<ul>
<li>metadata-managerは、メタデータ格納先に対して、**1テーブル単位の表統計**を登録・更新する。</li>
<li>登録・更新の単位を、1テーブル単位の表統計としている理由<ul>
<li>PostgreSQLの次のソースコードを参考にした。<ul>
<li>postgresql-12.3/src/backend/commands/vacuum.c<ul>
<li><p class="startli">PostgreSQLの場合、表統計登録・更新APIは、引数としてテーブルIDを含むRelation構造体・行数num_tuplesが指定される。</p>
<p class="startli">```C /*</p><ul>
<li>vac_update_relstats() &ndash; update statistics for one relation （略） */ void vac_update_relstats(Relation relation, BlockNumber num_pages, double num_tuples, BlockNumber num_all_visible_pages, bool hasindex, TransactionId frozenxid, MultiXactId minmulti, bool in_outer_xact) { Oid relid = RelationGetRelid(relation); ```</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>引数</h4>
<table class="doxtable">
<tr>
<th>プロパティ名<br />
（論理名） </th><th>プロパティ名<br />
（物理名） </th><th>型 </th><th>型の備考 </th><th>IN/OUT </th><th>省略指定 </th><th>値の範囲  </th></tr>
<tr>
<td>テーブル名 </td><td>table_name </td><td>std::string_view </td><td></td><td>IN </td><td>省略不可 </td><td>1桁以上 </td></tr>
<tr>
<td>行数 </td><td>reltuples </td><td>float </td><td></td><td>IN </td><td>省略不可 </td><td>型の範囲 </td></tr>
<tr>
<td>テーブルID </td><td>table_id </td><td>int64_t* </td><td><b>ポインタ</b> </td><td>OUT </td><td>省略可 </td><td>型の範囲 </td></tr>
</table>
<h4>戻り値</h4>
<table class="doxtable">
<tr>
<th>プロパティ名（論理名） </th><th>型 </th><th>値の範囲  </th></tr>
<tr>
<td>エラーコード </td><td>ErrorCode </td><td>ErrorCode::OK：正常<br />
ErrorCode::INVALID_PARAMETER：引数に、存在しないテーブル名が入力された。<br />
ErrorCode::DATABASE_ACCESS_FAILURE：メタデータ格納先に障害が発生した。 </td></tr>
</table>
<h4>条件</h4>
<ul>
<li>事前条件<ul>
<li>引数に、テーブルID、行数が指定されている。</li>
</ul>
</li>
<li>事後条件<ul>
<li>戻り値として、ErrorCodeを返す。</li>
<li>引数table_idに、列統計テーブル【tsurugi_class】に対して登録・更新が成功したレコードのテーブルIDを設定する。</li>
</ul>
</li>
</ul>
<h4>処理詳細</h4>
<ol type="1">
<li>metadata-managerは、事前条件に基づき、引数の入力規則チェックを実施する。<ul>
<li>テーブル名 = ""（空文字）<ul>
<li>metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。</li>
</ul>
</li>
</ul>
</li>
<li>メタデータ格納先はTransactionを開始する。</li>
<li>metadata-managerは、引数table_name、reltuplesを基に、Tableメタデータテーブル【tsurugi_class】の列reltuplesを更新する。</li>
<li>3.でレコードの登録・更新に成功した場合<ol type="a">
<li>メタデータ格納先は、commit処理を行い、Transactionを終了する。</li>
<li>metadata-managerは、引数table_idに、Tableメタデータテーブル【tsurugi_class】に対して登録・更新が成功したレコードのテーブルIDを設定する。</li>
<li>metadata-managerは、戻り値にErrorCode::OKを設定し、処理を終了する。</li>
</ol>
</li>
<li>3.でレコードの登録・更新に失敗した場合<ol type="a">
<li>メタデータ格納先は、rollback処理を行い、Transactionを終了する。</li>
<li>metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。</li>
</ol>
</li>
</ol>
<h3>1テーブルの全列統計参照（input：テーブルID）</h3>
<h4>処理概要</h4>
<ul>
<li>metadata-managerは、メタデータ格納先から、次のメタデータを一括で取得する。<ul>
<li>1テーブルに紐づく全カラムそれぞれのカラム番号とその列統計(std::unordered_map)</li>
</ul>
</li>
<li>上記メタデータを一括で取得する理由<ul>
<li>「1カラムの列統計参照（input：テーブルID・カラム番号）」APIより、メタデータ格納先へのアクセス回数を減らし、メモリに展開して計算できるようにするため。</li>
</ul>
</li>
</ul>
<h4>引数</h4>
<table class="doxtable">
<tr>
<th>プロパティ名（論理名） </th><th>プロパティ名（物理名） </th><th>型 </th><th>型の備考 </th><th>IN/OUT </th><th>省略指定 </th><th>値の範囲  </th></tr>
<tr>
<td>テーブルID </td><td>table_id </td><td>int64_t </td><td></td><td>IN </td><td>省略不可 </td><td>1以上 </td></tr>
<tr>
<td>1テーブルに紐づく全カラムそれぞれのカラム番号とその列統計(std::unordered_map) </td><td>column_statistics </td><td>std::unordered_map&lt;int64_t,ColumnStatistic&gt;&amp; </td><td><b>参照渡し</b> </td><td>OUT </td><td>省略不可 </td><td>型の範囲 </td></tr>
</table>
<h4>戻り値</h4>
<table class="doxtable">
<tr>
<th>プロパティ名（論理名） </th><th>型 </th><th>値の範囲  </th></tr>
<tr>
<td>エラーコード </td><td>ErrorCode </td><td>ErrorCode::OK：正常<br />
ErrorCode::INVALID_PARAMETER：引数に存在しないテーブルIDが指定された </td></tr>
</table>
<h4>条件</h4>
<ul>
<li>事前条件<ul>
<li>引数に、テーブルIDが指定されている。</li>
</ul>
</li>
<li>事後条件<ul>
<li>戻り値として、ErrorCodeを返す。</li>
<li>ErrorCode::OKの場合<ul>
<li>column_statisticsに、1テーブルに紐づく全カラムそれぞれのカラム番号とその列統計(std::unordered_map)が格納される。<ul>
<li>std::unordered_map型の値<ul>
<li>key: カラム番号</li>
<li>value: ColumnStatistic</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>処理詳細</h4>
<ol type="1">
<li>metadata-managerは、事前条件に基づき、引数の入力規則チェックを実施する。<ul>
<li>テーブルID &lt;= 0の場合<ul>
<li>metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。</li>
</ul>
</li>
</ul>
</li>
<li>metadata-managerは、メタデータ格納先の列統計テーブル【tsurugi_statistic】から、テーブルIDが引数テーブルIDに一致する全レコードを取得する。<ul>
<li>一致するレコードの取得に成功した場合<ol type="a">
<li>metadata-managerは、引数column_statisticsに、取得したレコードを設定する。</li>
<li>metadata-managerは、戻り値にErrorCode::OKを設定し、処理を終了する。</li>
</ol>
</li>
<li>それ以外の場合<ul>
<li>metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3>1カラムの列統計参照（input：テーブルID・カラム番号）</h3>
<h4>処理概要</h4>
<ul>
<li>metadata-managerは、メタデータ格納先から、**1カラム単位の列統計**を取得する。</li>
<li>本APIを定義した理由<ul>
<li>PostgreSQLの次のソースコードを参考にした。<ul>
<li><p class="startli">postgresql-12.3/src/backend/utils/adt/selfuncs.c</p>
<p class="startli">```C /*</p><ul>
<li>examine_variable</li>
<li>Try to look up statistical data about an expression.</li>
<li><p class="startli">Fill in a VariableStatData struct to describe the expression. （略） */ void examine_variable(PlannerInfo *root, Node *node, int varRelid, VariableStatData *vardata) { （略） vardata-&gt;rel = find_base_rel(root, var-&gt;varno);</p>
<p class="startli">/* Try to locate some stats */ examine_simple_variable(root, var, vardata); ```</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>find_base_rel</p><ul>
<li>1テーブルの次のメタデータを取得<ul>
<li>行数</li>
<li>ページ数</li>
</ul>
</li>
</ul>
<p>examine_simple_variable</p><ul>
<li>テーブルID・カラム番号・rte-&gt;inhを引数として、1カラムの列統計を取得している。</li>
</ul>
<h4>引数</h4>
<table class="doxtable">
<tr>
<th>プロパティ名（論理名） </th><th>プロパティ名（物理名） </th><th>型 </th><th>型の備考 </th><th>IN/OUT </th><th>省略指定 </th><th>値の範囲  </th></tr>
<tr>
<td>テーブルID </td><td>table_id </td><td>int64_t </td><td></td><td>IN </td><td>省略不可 </td><td>1以上 </td></tr>
<tr>
<td>カラム番号(1 origin) </td><td>ordinal_position </td><td>int64_t </td><td></td><td>IN </td><td>省略不可 </td><td>1以上 </td></tr>
<tr>
<td>1カラム単位の列統計 </td><td>column_statistic </td><td>ColumnStatistic&amp; </td><td><b>参照渡し</b> </td><td>OUT </td><td>省略不可 </td><td>型の範囲 </td></tr>
</table>
<h4>戻り値</h4>
<table class="doxtable">
<tr>
<th>プロパティ名（論理名） </th><th>型 </th><th>値の範囲  </th></tr>
<tr>
<td>エラーコード </td><td>ErrorCode </td><td>ErrorCode::OK：正常<br />
ErrorCode::INVALID_PARAMETER：引数に存在しないテーブルID・カラム番号が指定された </td></tr>
</table>
<h4>条件</h4>
<ul>
<li>事前条件<ul>
<li>引数に、テーブルID、カラム番号が指定されている。</li>
</ul>
</li>
<li>事後条件<ul>
<li>戻り値として、ErrorCodeを返す。</li>
<li>ErrorCode::OKの場合<ul>
<li>column_statisticに列統計の値が格納される。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>処理詳細</h4>
<ol type="1">
<li>metadata-managerは、事前条件に基づき、引数の入力規則チェックを実施する。<ul>
<li>テーブルID &lt;= 0 または　カラム番号 &lt;= 0<ul>
<li>metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。</li>
</ul>
</li>
</ul>
</li>
<li>metadata-managerは、メタデータ格納先の列統計テーブル【tsurugi_statistic】から、テーブルID、カラム番号が、引数テーブルID、カラム番号それぞれに一致するレコードを取得する。<ul>
<li>一致するレコードの取得に成功した場合<ol type="a">
<li>metadata-managerは、引数column_statisticに、取得したレコードを設定する。</li>
<li>metadata-managerは、戻り値にErrorCode::OKを設定し、処理を終了する。</li>
</ol>
</li>
<li>それ以外の場合<ul>
<li>metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3>1テーブルの表統計参照（input：テーブルID）</h3>
<h4>処理概要</h4>
<ul>
<li>metadata-managerは、メタデータ格納先から、1テーブルに紐づく表統計と、Tableメタデータ全項目の値を取得する。</li>
</ul>
<h4>引数</h4>
<table class="doxtable">
<tr>
<th>プロパティ名（論理名） </th><th>プロパティ名（物理名） </th><th>型 </th><th>型の備考 </th><th>IN/OUT </th><th>省略指定 </th><th>値の範囲  </th></tr>
<tr>
<td>テーブルID </td><td>table_id </td><td>int64_t </td><td></td><td>IN </td><td>省略不可 </td><td>1以上 </td></tr>
<tr>
<td>1テーブルに紐づく表統計と、Tableメタデータ全項目の値 </td><td>table_statistic </td><td>TableStatistic&amp; </td><td><b>参照渡し</b> </td><td>OUT </td><td>省略不可 </td><td>型の範囲 </td></tr>
</table>
<h4>戻り値</h4>
<table class="doxtable">
<tr>
<th>プロパティ名（論理名） </th><th>型 </th><th>値の範囲  </th></tr>
<tr>
<td>エラーコード </td><td>ErrorCode </td><td>ErrorCode::OK：正常<br />
ErrorCode::INVALID_PARAMETER：引数に存在しないテーブルIDが指定された </td></tr>
</table>
<h4>条件</h4>
<ul>
<li>事前条件<ul>
<li>引数に、テーブルIDが指定されている。</li>
</ul>
</li>
<li>事後条件<ul>
<li>戻り値として、ErrorCodeを返す。</li>
<li>ErrorCode::OKの場合<ul>
<li>table_statisticに、1テーブルに紐づく表統計と、Tableメタデータ全項目の値が格納される。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>処理詳細</h4>
<ol type="1">
<li>metadata-managerは、事前条件に基づき、引数の入力規則チェックを実施する。<ul>
<li>テーブルID &lt;= 0<ul>
<li>metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。</li>
</ul>
</li>
</ul>
</li>
<li>metadata-managerは、メタデータ格納先のTableメタデータテーブル【tsurugi_class】から、テーブルIDが引数table_idに一致するレコードを取得する。<ul>
<li>一致するレコードの取得に成功した場合<ul>
<li>metadata-managerは、引数table_statisticに、取得したレコードを設定し、処理を終了する。</li>
</ul>
</li>
<li>それ以外の場合<ul>
<li>metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3>1テーブルの表統計参照（input：テーブル名、output：テーブルID・行数）</h3>
<h4>処理概要</h4>
<ul>
<li>metadata-managerは、メタデータ格納先から、1テーブルに紐づく表統計と、Tableメタデータ全項目の値を取得する。</li>
</ul>
<h4>引数</h4>
<table class="doxtable">
<tr>
<th>プロパティ名（論理名） </th><th>プロパティ名（物理名） </th><th>型 </th><th>型の備考 </th><th>IN/OUT </th><th>省略指定 </th><th>値の範囲  </th></tr>
<tr>
<td>テーブル名 </td><td>table_name </td><td>std::string_view </td><td></td><td>IN </td><td>省略不可 </td><td>1桁以上 </td></tr>
<tr>
<td>1テーブルに紐づく表統計と、Tableメタデータ全項目の値 </td><td>table_statistic </td><td>TableStatistic&amp; </td><td><b>参照渡し</b> </td><td>OUT </td><td>省略不可 </td><td>型の範囲 </td></tr>
</table>
<h4>戻り値</h4>
<table class="doxtable">
<tr>
<th>プロパティ名（論理名） </th><th>型 </th><th>値の範囲  </th></tr>
<tr>
<td>エラーコード </td><td>ErrorCode </td><td>ErrorCode::OK：正常<br />
ErrorCode::INVALID_PARAMETER：引数に存在しないテーブル名が指定された </td></tr>
</table>
<h4>条件</h4>
<ul>
<li>事前条件<ul>
<li>引数に、テーブルIDが指定されている。</li>
</ul>
</li>
<li>事後条件<ul>
<li>戻り値として、ErrorCodeを返す。</li>
<li>ErrorCode::OKの場合<ul>
<li>table_statisticに、1テーブルに紐づく表統計と、Tableメタデータ全項目の値が格納される。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>処理詳細</h4>
<ol type="1">
<li>metadata-managerは、事前条件に基づき、引数の入力規則チェックを実施する。<ul>
<li>テーブル名 = ""（空文字）<ul>
<li>metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。</li>
</ul>
</li>
</ul>
</li>
<li>metadata-managerは、メタデータ格納先のTableメタデータテーブル【tsurugi_class】から、テーブルIDが引数table_nameに一致するレコードを取得する。<ul>
<li>一致するレコードの取得に成功した場合<ul>
<li>metadata-managerは、引数table_statisticに、取得したレコードを設定し、処理を終了する。</li>
</ul>
</li>
<li>それ以外の場合<ul>
<li>metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3>1テーブルの全列統計削除（input：テーブルID）</h3>
<h4>処理概要</h4>
<ul>
<li>metadata-managerは、メタデータ格納先から、**1テーブルに紐づく列統計の全レコード**を削除する。</li>
<li>本APIを定義した理由<ul>
<li>DROP TABLE機能から、本APIを呼ぶ想定のため。</li>
</ul>
</li>
</ul>
<h4>引数</h4>
<table class="doxtable">
<tr>
<th>プロパティ名（論理名） </th><th>プロパティ名（物理名） </th><th>型 </th><th>IN/OUT </th><th>省略指定 </th><th>値の範囲  </th></tr>
<tr>
<td>テーブルID </td><td>table_id </td><td>int64_t </td><td>IN </td><td>省略不可 </td><td>1以上 </td></tr>
</table>
<h4>戻り値</h4>
<table class="doxtable">
<tr>
<th>プロパティ名（論理名） </th><th>型 </th><th>値の範囲  </th></tr>
<tr>
<td>エラーコード </td><td>ErrorCode </td><td>ErrorCode::OK：正常<br />
ErrorCode::INVALID_PARAMETER：引数に存在しないテーブルIDが指定された<br />
ErrorCode::DATABASE_ACCESS_FAILURE：メタデータ格納先に障害が発生した。 </td></tr>
</table>
<h4>条件</h4>
<ul>
<li>事前条件<ul>
<li>引数に、テーブルIDが指定されている。</li>
</ul>
</li>
<li>事後条件<ul>
<li>戻り値として、ErrorCodeを返す。</li>
</ul>
</li>
</ul>
<h4>処理詳細</h4>
<ol type="1">
<li>metadata-managerは、事前条件に基づき、引数の入力規則チェックを実施する。<ul>
<li>テーブルID &lt;= 0<ul>
<li>metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。</li>
</ul>
</li>
</ul>
</li>
<li>メタデータ格納先は、Transactionを開始する。</li>
<li>metadata-managerは、メタデータ格納先の列統計テーブル【tsurugi_statistic】から、テーブルIDが引数table_idに一致する全レコードを削除する。</li>
<li>3.でレコードの削除に成功した場合<ol type="a">
<li>メタデータ格納先は、commit処理を行い、Transactionを終了する。</li>
<li>metadata-managerは、戻り値にErrorCode::OKを設定し、処理を終了する。</li>
</ol>
</li>
<li>3.でレコードの削除に失敗した場合<ol type="a">
<li>メタデータ格納先は、rollback処理を行い、Transactionを終了する。</li>
<li>metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。</li>
</ol>
</li>
</ol>
<h3>1カラムの列統計削除（input：テーブルID・カラム番号）</h3>
<h4>処理概要</h4>
<ul>
<li>metadata-managerは、メタデータ格納先から、**1カラムの列統計**を削除する。</li>
<li>本APIを定義した理由<ul>
<li>ALTER TABLE機能から、本APIを呼ぶ想定のため。</li>
<li>PostgreSQLの次の関数を参考にした。<ul>
<li><p class="startli">postgresql-12.3/src/backend/catalog/heap.c</p>
<p class="startli">```C /*</p><ul>
<li>RemoveStatistics &mdash; remove entries in pg_statistic for a rel or column</li>
<li></li>
<li>If attnum is zero, remove all entries for rel; else remove only the one(s)</li>
<li>for that column. */ void RemoveStatistics(Oid relid, AttrNumber attnum) ```</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>引数</h4>
<table class="doxtable">
<tr>
<th>プロパティ名（論理名） </th><th>プロパティ名（物理名） </th><th>型 </th><th>IN/OUT </th><th>省略指定 </th><th>値の範囲  </th></tr>
<tr>
<td>テーブルID </td><td>table_id </td><td>int64_t </td><td>IN </td><td>省略不可 </td><td>1以上 </td></tr>
<tr>
<td>カラム番号(1 origin) </td><td>ordinal_position </td><td>int64_t </td><td>IN </td><td>省略不可 </td><td>1以上 </td></tr>
</table>
<h4>戻り値</h4>
<table class="doxtable">
<tr>
<th>プロパティ名（論理名） </th><th>型 </th><th>値の範囲  </th></tr>
<tr>
<td>エラーコード </td><td>ErrorCode </td><td>ErrorCode::OK：正常<br />
ErrorCode::INVALID_PARAMETER：引数に存在しないテーブルID・カラム番号が指定された。<br />
ErrorCode::DATABASE_ACCESS_FAILURE：メタデータ格納先に障害が発生した。 </td></tr>
</table>
<h4>条件</h4>
<ul>
<li>事前条件<ul>
<li>引数に、テーブルID・カラム番号が指定されている。</li>
</ul>
</li>
<li>事後条件<ul>
<li>戻り値として、ErrorCodeを返す。</li>
</ul>
</li>
</ul>
<h4>処理詳細</h4>
<ol type="1">
<li>metadata-managerは、事前条件に基づき、引数の入力規則チェックを実施する。<ul>
<li>テーブルID &lt;= 0 または カラム番号 &lt;= 0<ul>
<li>metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。</li>
</ul>
</li>
</ul>
</li>
<li>メタデータ格納先は、Transactionを開始する。</li>
<li>metadata-managerは、メタデータ格納先の列統計テーブル【tsurugi_statistic】から、テーブルID・カラム番号が引数テーブルID、カラム番号に一致するレコードを削除する。</li>
<li>3.でレコードの削除に成功した場合<ol type="a">
<li>メタデータ格納先は、commit処理を行い、Transactionを終了する。</li>
<li>metadata-managerは、戻り値にErrorCode::OKを設定し、処理を終了する。</li>
</ol>
</li>
<li>3.でレコードの削除に失敗した場合<ol type="a">
<li>メタデータ格納先は、rollback処理を行い、Transactionを終了する。</li>
<li>metadata-managerは、戻り値にErrorCode::INVALID_PARAMETERを設定し、処理を終了する。</li>
</ol>
</li>
</ol>
<h2>エラーコード一覧</h2>
<table class="doxtable">
<tr>
<th>エラーコード</th><th>説明  </th></tr>
<tr>
<td>OK</td><td>正常 </td></tr>
<tr>
<td>INVALID_PARAMETER</td><td>引数に不正なパラメーターが入力された。metadata-managerのAPIを利用するコンポーネントに問題があり、<br />
metadata-managerのAPIに入力するパラメーターを修正する必要がある可能性が高い。<br />
・UPDATE/INSERT/UPSERT文の発行に失敗：メタデータ格納先のテーブルに対して、制約に違反するレコードの登録・更新を行った。<br />
存在しないテーブルID（またはテーブル名）またはカラム番号のレコードの更新を行った。<br />
・DELETE文の発行に失敗：メタデータ格納先のテーブルに対して、存在しないテーブルID（またはテーブル名）またはカラム番号のレコードの削除を行った。<br />
・SELECT文の発行に失敗：メタデータ格納先のテーブルに対して、存在しないテーブルID（またはテーブル名）またはカラム番号のレコードの参照を行った。<br />
・または、メタデータ格納先に障害が発生した。 </td></tr>
<tr>
<td>DATABASE_ACCESS_FAILURE</td><td>メタデータ格納先に障害が発生した。メタデータ格納先（データベース）周りに問題があり、<br />
metadata-managerのAPIを利用するコンポーネントは処理を続行できない可能性が高い。<br />
・初期化処理に失敗した場合（コネクションの確立、またはセキュアなサーチパスの設定に失敗、またはプリペアードステートメントの前処理の実行に失敗）<br />
・トランザクションの開始に失敗<br />
・コミット失敗<br />
・ロールバック失敗 </td></tr>
<tr>
<td>INTERNAL_ERROR</td><td>API側のエラー（メモリ確保エラーやファイル作成エラーなど） </td></tr>
</table>
<h2>ログ</h2>
<ul>
<li>metadata-managerは、metadata-manager V2.0と同等レベルで、標準エラー出力を行う。</li>
</ul>
<p>以上 </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
