<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>manager: 統計情報管理機能_詳細設計書</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">manager
   &#160;<span id="projectnumber">..</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">統計情報管理機能_詳細設計書 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>【Project-Tsurugi Internal Use Only】</p>
<h1>列統計・表統計 管理機能 詳細設計</h1>
<p>2021.02.03 NEC</p>
<h2>目次</h2>
<ul>
<li><a href="#列統計表統計-管理機能-詳細設計">列統計・表統計 管理機能 詳細設計</a><ul>
<li><a href="#目次">目次</a></li>
<li><a href="#デザインパターン">デザインパターン</a></li>
<li><a href="#クラス図">クラス図</a><ul>
<li><a href="#dao">*DAO</a><ul>
<li><a href="#説明">説明</a></li>
<li><a href="#method">method</a></li>
</ul>
</li>
<li><a href="#dbsessionmanager">DBSessionManager</a><ul>
<li><a href="#説明-1">説明</a></li>
<li><a href="#config">Config</a><ul>
<li><a href="#説明-2">説明</a></li>
<li><a href="#field">field</a></li>
<li><a href="#method-1">method</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#dialectstrategy">DialectStrategy</a><ul>
<li><a href="#説明-3">説明</a></li>
<li><a href="#field-1">field</a></li>
<li><a href="#method-2">method</a></li>
</ul>
</li>
<li><a href="#dialect">*Dialect</a><ul>
<li><a href="#説明-4">説明</a></li>
<li><a href="#method-3">method</a></li>
</ul>
</li>
<li><a href="#daoで利用するenum">DAOで利用するenum</a><ul>
<li><a href="#statement_name">StatementName</a></li>
<li><a href="#table_name">TableName</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#シーケンス図">シーケンス図</a><ul>
<li><a href="#初期化処理">初期化処理</a></li>
<li><a href="#終了処理">終了処理</a></li>
<li><a href="#upsert_update_delete_api_共通シーケンス_開始終了処理">UPSERT_UPDATE_DELETE_API_共通シーケンス_開始・終了処理</a></li>
<li><a href="#登録・更新">登録・更新</a><ul>
<li><a href="#1カラムの列統計登録更新inputテーブルidカラム番号">1カラムの列統計登録・更新（input：テーブルID・カラム番号）</a></li>
<li><a href="#1テーブルの表統計登録更新inputテーブルid行数">1テーブルの表統計登録・更新（input：テーブルID・行数）</a></li>
<li><a href="#1テーブルの表統計登録更新inputテーブル名行数outputテーブルid">1テーブルの表統計登録・更新（input：テーブル名・行数、output：テーブルID）</a></li>
</ul>
</li>
<li><a href="#参照">参照</a><ul>
<li><a href="#1テーブルの全列統計参照inputテーブルid">1テーブルの全列統計参照（input：テーブルID）</a></li>
<li><a href="#1カラムの列統計参照inputテーブルidカラム番号">1カラムの列統計参照（input：テーブルID・カラム番号）</a></li>
<li><a href="#1テーブルの表統計参照inputテーブルid">1テーブルの表統計参照（input：テーブルID）</a></li>
<li><a href="#1テーブルの表統計参照inputテーブル名outputテーブルid行数">1テーブルの表統計参照（input：テーブル名、output：テーブルID・行数）</a></li>
</ul>
</li>
<li><a href="#削除">削除</a><ul>
<li><a href="#1テーブルの全列統計削除inputテーブルid">1テーブルの全列統計削除（input：テーブルID）</a></li>
<li><a href="#1カラムの列統計削除inputテーブルidカラム番号">1カラムの列統計削除（input：テーブルID・カラム番号）</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#メタデータ格納先のリポジトリ設計">メタデータ格納先のリポジトリ設計</a><ul>
<li><a href="#コミットロールバックトランザクション管理">コミット/ロールバック(トランザクション管理)</a></li>
<li><a href="#メタデータ格納先のテーブルに対するロック制御">メタデータ格納先のテーブルに対するロック制御</a><ul>
<li><a href="#列統計表統計登録更新削除機能">列統計・表統計登録/更新/削除機能</a></li>
<li><a href="#列統計表統計参照機能">列統計・表統計参照機能</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2>デザインパターン</h2>
<ul>
<li>DAO Managerパターンを利用する。<ul>
<li>コネクションプーリングを実施するため。<ul>
<li>理由<ul>
<li>メタデータ格納先へのコネクション確立回数を減らすため。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>参考<ul>
<li>The DAO Manager<ul>
<li><a href="https://stackoverflow.com/questions/12812256/how-do-i-implement-a-dao-manager-using-jdbc-and-connection-pools">https://stackoverflow.com/questions/12812256/how-do-i-implement-a-dao-manager-using-jdbc-and-connection-pools</a></li>
<li><a href="http://tutorials.jenkov.com/java-persistence/dao-manager.html">http://tutorials.jenkov.com/java-persistence/dao-manager.html</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2>クラス図</h2>
<div class="image">
<img src="./out/uml/ClassDiagram_detail/ClassDiagram_overview_dao.png"/>
</div>
<h3>*DAO</h3>
<div class="image">
<img src="./out/uml/ClassDiagram_detail/ClassDiagram_detail_dao.png"/>
</div>
<h4>説明</h4>
<ul>
<li>DAO(Data Access Object)</li>
<li>メタデータ格納先にプリペアードステートメントを発行して、メタデータにアクセスする。</li>
<li>クラス名の例<ul>
<li>StatisticsDAO</li>
</ul>
</li>
</ul>
<h4>method</h4>
<ul>
<li>prepareStatements()<ul>
<li>prepare()を呼ぶ。</li>
</ul>
</li>
<li>prepare()<ul>
<li>メタデータ格納先にプリペアードステートメントを送り、前処理を実行する。</li>
</ul>
</li>
<li>その他のメソッド<ul>
<li>StatisticsDAOは、メタデータ格納先に対して列統計・表統計の登録・更新・参照・削除のプリペアードステートメントを発行する。</li>
<li>TablesDAOは、メタデータ格納先に対してTableメタデータ・Columnメタデータの登録・更新・参照・削除のプリペアードステートメントを発行する。</li>
</ul>
</li>
</ul>
<h3>DBSessionManager</h3>
<div class="image">
<img src="./out/uml/ClassDiagram_detail/ClassDiagram_detail_dbsm.png"/>
</div>
<h4>説明</h4>
<ul>
<li>メタデータ格納先とのコネクションの確立・切断・コネクションプーリングを実施する。</li>
<li>DAOを生成して返却する。</li>
<li><b>サービス層のクラスと1対1関係とする。</b></li>
</ul>
<h4>Config</h4>
<h5>説明</h5>
<ul>
<li>OSの環境変数から、Connection Stringsを取得する。</li>
</ul>
<h5>method</h5>
<ul>
<li>get_connection_string<ul>
<li>OSの環境変数から、Connection Stringsを取得する。</li>
</ul>
</li>
</ul>
<h3>DialectStrategy</h3>
<div class="image">
<img src="./out/uml/ClassDiagram_detail/ClassDiagram_detail_dialect.png"/>
</div>
<h4>説明</h4>
<ul>
<li>1つの*Dialectインスタンスを返す。<ul>
<li>たとえば、PostgreSQLDialectインスタンスを返す。</li>
</ul>
</li>
<li>メタデータ格納先（たとえば、PostgreSQL）が別のDBMSに変更された場合、メタデータ格納先のDBMSに発行するクエリ文字列を切り替えることができるようにする。</li>
<li>*DAOからプリペアードステートメントのクエリ文字列を取得する例</li>
</ul>
<div class="fragment"><div class="line">{C++}</div><div class="line">DialectStrategy::getInstance()-&gt;StatisticsDAO_upsertOneColumnStatisticByTableIdColumnOrdinalPosition()</div></div><!-- fragment --><h4>field</h4>
<ul>
<li>instance<ul>
<li>*Dialectインスタンスを格納する。</li>
</ul>
</li>
</ul>
<h4>method</h4>
<ul>
<li>getInstance<ul>
<li>instanceに格納されている*Dialectインスタンスを返す。</li>
</ul>
</li>
</ul>
<h3>*Dialect</h3>
<h4>説明</h4>
<ul>
<li>DAOで実行するプリペアードステートメントのクエリ文字列を返す。</li>
<li>クラス名の例<ul>
<li>PostgreSQLDialect</li>
</ul>
</li>
</ul>
<h4>method</h4>
<ul>
<li>すべてのメソッド<ul>
<li>DAOで実行するプリペアードステートメントのクエリ文字列を返す。</li>
<li><p class="startli">プリペアードステートメントのクエリ文字列の例</p>
<p class="startli">```sql update tsurugi_class set reltuples = ? where tableId = ?; ```</p>
</li>
</ul>
</li>
</ul>
<h3>DAOで利用するenum</h3>
<div class="image">
<img src="./out/uml/ClassDiagram_detail/ClassDiagram_detail_dao_enum.png"/>
</div>
<h4>StatementName</h4>
<ul>
<li>プリペアードステートメントを一意に識別するためのステートメント文字列を格納する。<ul>
<li>ステートメント文字列<ul>
<li><p class="startli">libpqのPQprepare関数の引数stmtName</p><ul>
<li><a href="https://www.postgresql.jp/document/12/html/libpq-exec.html">https://www.postgresql.jp/document/12/html/libpq-exec.html</a></li>
</ul>
<p class="startli">```C PGresult *PQprepare(PGconn *conn, const char *stmtName, const char *query, int nParams, const Oid *paramTypes); ```</p><ul>
<li>stmtName<ul>
<li>unique name for the new prepared statement.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>TableName</h4>
<ul>
<li>各DAOを一意に識別する名前。</li>
</ul>
<h2>シーケンス図</h2>
<h3>初期化処理</h3>
<div class="image">
<img src="./out/uml/SequenceDiagram_detail/初期化処理.png"/>
</div>
<h3>終了処理</h3>
<ul>
<li>PGConnをstd::shared_ptr&lt;PGconn&gt;で定義して、std::shared_ptr&lt;PGconn&gt;のdeleterで、PQfinishを呼ぶ。</li>
</ul>
<div class="fragment"><div class="line">{C++}</div><div class="line">std::shared_ptr&lt;PGconn&gt; conn(pgconn, [](PGconn *c) { ::PQfinish(c); });</div></div><!-- fragment --><h3>UPSERT_UPDATE_DELETE_API_共通シーケンス_開始・終了処理</h3>
<div class="image">
<img src="./out/uml/SequenceDiagram_detail/UPSERT_UPDATE_DELETE_API_共通シーケンス_開始・終了処理.png"/>
</div>
<h3>登録・更新</h3>
<h4>1カラムの列統計登録・更新（input：テーブルID・カラム番号）</h4>
<div class="image">
<img src="./out/uml/SequenceDiagram_detail/1カラムの列統計登録・更新（input：テーブルID・カラム番号）.png"/>
</div>
<h4>1テーブルの表統計登録・更新（input：テーブルID・行数）</h4>
<div class="image">
<img src="./out/uml/SequenceDiagram_detail/1テーブルの表統計登録・更新（input：テーブルID・行数）.png"/>
</div>
<h4>1テーブルの表統計登録・更新（input：テーブル名・行数、output：テーブルID）</h4>
<div class="image">
<img src="./out/uml/SequenceDiagram_detail/1テーブルの表統計登録・更新（input：テーブル名・行数、output：テーブルID）.png"/>
</div>
<h3>参照</h3>
<h4>1テーブルの全列統計参照（input：テーブルID）</h4>
<div class="image">
<img src="./out/uml/SequenceDiagram_detail/1テーブルの全列統計参照（input：テーブルID）.png"/>
</div>
<h4>1カラムの列統計参照（input：テーブルID・カラム番号）</h4>
<div class="image">
<img src="./out/uml/SequenceDiagram_detail/1カラムの列統計参照（input：テーブルID・カラム番号）.png"/>
</div>
<h4>1テーブルの表統計参照（input：テーブルID）</h4>
<div class="image">
<img src="./out/uml/SequenceDiagram_detail/1テーブルの表統計参照（input：テーブルID）.png"/>
</div>
<h4>1テーブルの表統計参照（input：テーブル名、output：テーブルID・行数）</h4>
<div class="image">
<img src="./out/uml/SequenceDiagram_detail/1テーブルの表統計参照（input：テーブル名、output：テーブルID・行数）.png"/>
</div>
<h3>削除</h3>
<h4>1テーブルの全列統計削除（input：テーブルID）</h4>
<div class="image">
<img src="./out/uml/SequenceDiagram_detail/1テーブルの全列統計削除（input：テーブルID）.png"/>
</div>
<h4>1カラムの列統計削除（input：テーブルID・カラム番号）</h4>
<div class="image">
<img src="./out/uml/SequenceDiagram_detail/1カラムの列統計削除（input：テーブルID・カラム番号）.png"/>
</div>
<h2>メタデータ格納先のリポジトリ設計</h2>
<h3>コミット/ロールバック(トランザクション管理)</h3>
<ul>
<li>metadata-managerは、メタデータ格納先のテーブルに対して、メタデータ格納先のコミット機能を利用し、メタデータ格納先のAutocommit機能は利用しない。<ul>
<li>具体的には、次の処理手順とする。<ol type="1">
<li>metadata-managerは、トランザクションの開始時点でBEGINコマンドを実行する。</li>
<li>metadata-managerは、INSERT/UPDATE/DELETE文を1つまたは複数発行する。</li>
<li>metadata-managerは、コミットを行う。<ul>
<li>ただし、コミットを行う前にエラーが発生した場合、ロールバックを行う。</li>
</ul>
</li>
</ol>
</li>
<li>途中でプログラムがエラー終了した場合も、メタデータ格納先の機能で自動ロールバックが行われるため、テーブルが不整合になることを防止できる。</li>
</ul>
</li>
</ul>
<h3>メタデータ格納先のテーブルに対するロック制御</h3>
<h4>列統計・表統計登録/更新/削除機能</h4>
<ul>
<li>metadata-managerとして、ロック制御を組み込むことは行わず、メタデータ格納先のロック制御の機能を利用する。</li>
</ul>
<h4>列統計・表統計参照機能</h4>
<ul>
<li>metadata-manager・メタデータ格納先ともに、ロック制御を行わない。</li>
</ul>
<p>以上 </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
